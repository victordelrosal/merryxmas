<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Merry Christmas</title>
  <meta name="description" content="Interactive Christmas card with animated tree, twinkling lights, and holiday music">

  <!-- Favicon & Apple Touch Icon -->
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="icon" type="image/png" sizes="512x512" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">

  <!-- Open Graph / Social Media Preview -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Merry Christmas">
  <meta property="og:description" content="Interactive Christmas card with animated tree, twinkling lights, and holiday music">
  <meta property="og:image" content="img/Merry Xmas.png">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Merry Christmas">
  <meta name="twitter:description" content="Interactive Christmas card with animated tree, twinkling lights, and holiday music">
  <meta name="twitter:image" content="img/Merry Xmas.png">

  <!-- Web App -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Merry Xmas">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; margin: 0; background: #06050a; overflow: hidden; }
    canvas { display: block; width: 100vw; height: 100vh; }
    .hint {
      position: fixed; left: 18px; bottom: 14px;
      font: 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.55);
      user-select: none; pointer-events: none;
      text-shadow: 0 1px 12px rgba(0,0,0,0.7);
    }
    .snow-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      perspective: 1000px;
      overflow: hidden;
    }
    .snowflake {
      position: absolute;
      user-select: none;
      animation: fall linear infinite;
      will-change: transform;
    }
    .snowflake span {
      display: block;
      color: #d0e8ff;
      animation: spin3d linear infinite;
    }
    @keyframes fall {
      0% { transform: translateY(-5vh) translateX(0); }
      100% { transform: translateY(105vh) translateX(20vw); }
    }
    @keyframes spin3d {
      0% { transform: rotateY(0deg); }
      100% { transform: rotateY(360deg); }
    }
    /* Glassmorphic Sidebar - Ultra Silk Smooth */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      width: 220px;
      background: linear-gradient(165deg,
        rgba(255,255,255,0.12) 0%,
        rgba(255,255,255,0.05) 40%,
        rgba(255,255,255,0.02) 100%);
      backdrop-filter: blur(20px) saturate(1.4);
      -webkit-backdrop-filter: blur(20px) saturate(1.4);
      border-right: 1px solid rgba(255,255,255,0.15);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.05),
        inset 1px 1px 0 rgba(255,255,255,0.1),
        0 0 20px rgba(0,0,0,0);
      z-index: 100;
      display: flex;
      flex-direction: column;
      font: 11px/1.4 system-ui, -apple-system, sans-serif;
      color: rgba(255,255,255,0.85);
      overflow: hidden;
      overflow-y: auto;
      transform: translateX(-168px);
      transition: transform 0.6s cubic-bezier(0.32, 0.72, 0, 1);
      will-change: transform;
      contain: layout style;
    }
    .sidebar.expanded {
      transform: translateX(0);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.05),
        inset 1px 1px 0 rgba(255,255,255,0.1),
        0 8px 32px rgba(0,0,0,0.4),
        0 0 80px rgba(0,0,0,0.2);
    }
    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }
    .sidebar-toggle {
      width: 100%;
      padding: 12px 8px;
      background: none;
      border: none;
      cursor: pointer;
      display: flex;
      flex-direction: row-reverse;
      justify-content: center;
      align-items: center;
      gap: 12px;
      color: rgba(255,255,255,0.7);
      transition: background 0.25s ease, color 0.25s ease;
    }
    .sidebar.expanded .sidebar-toggle {
      flex-direction: row;
      justify-content: flex-start;
      padding-left: 14px;
    }
    .sidebar-toggle:hover {
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.95);
    }
    .sidebar-toggle .chevron-icon {
      flex-shrink: 0;
      transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1),
                  opacity 0.25s ease;
      opacity: 0.9;
      filter: drop-shadow(0 0 4px rgba(255,255,255,0.3));
    }
    .sidebar-toggle:hover .chevron-icon {
      opacity: 1;
      filter: drop-shadow(0 0 8px rgba(255,255,255,0.5));
    }
    .sidebar.expanded .sidebar-toggle .chevron-icon {
      transform: rotate(180deg);
      opacity: 0.6;
      filter: none;
    }
    .sidebar.expanded .sidebar-toggle:hover .chevron-icon {
      opacity: 0.9;
    }
    .sidebar-toggle span {
      opacity: 0;
      white-space: nowrap;
      transition: opacity 0.25s ease;
      flex: 1;
    }
    .sidebar.expanded .sidebar-toggle span {
      opacity: 1;
    }

    .sidebar-section {
      padding: 4px 0;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .control-group {
      display: flex;
      flex-direction: row-reverse;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 4px 8px;
      border-radius: 8px;
      transition: background 0.3s ease;
    }
    .sidebar.expanded .control-group {
      flex-direction: row;
      justify-content: flex-start;
    }
    .control-group:hover { background: rgba(255,255,255,0.06); }
    .control-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      flex-shrink: 0;
      cursor: pointer;
      box-shadow:
        0 2px 8px rgba(0,0,0,0.2),
        inset 0 1px 0 rgba(255,255,255,0.15),
        inset 0 -1px 0 rgba(0,0,0,0.1);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      transition: all 0.25s ease;
    }
    .control-icon:hover,
    .control-group:hover .control-icon {
      transform: scale(1.05);
      box-shadow:
        0 4px 16px rgba(0,0,0,0.3),
        inset 0 1px 0 rgba(255,255,255,0.2),
        0 0 20px rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.25);
      background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
    }
    .control-icon svg {
      width: 18px;
      height: 18px;
      stroke: rgba(255,255,255,0.75);
      fill: none;
      stroke-width: 1.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      transition: stroke 0.3s ease;
    }
    .control-group:hover .control-icon svg {
      stroke: rgba(255,255,255,0.95);
    }
    .control-content {
      flex: 1;
      min-width: 0;
      opacity: 0;
      transition: opacity 0.35s ease;
      transition-delay: 0.15s;
    }
    .sidebar.expanded .control-content {
      opacity: 1;
      transition-delay: 0.2s;
    }
    .control-label {
      font-size: 10px;
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .control-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .control-row input[type="range"] {
      flex: 1;
      height: 4px;
      -webkit-appearance: none;
      background: rgba(255,255,255,0.15);
      border-radius: 2px;
      outline: none;
    }
    .control-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(200,220,255,0.7));
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
    .control-value {
      font-size: 11px;
      color: rgba(255,255,255,0.6);
      min-width: 28px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .control-btn {
      width: 100%;
      padding: 7px 10px;
      background: linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: rgba(255,255,255,0.85);
      font-size: 11px;
      cursor: pointer;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.1),
        0 2px 4px rgba(0,0,0,0.15);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      transition: all 0.2s ease;
    }
    .control-btn:hover {
      background: linear-gradient(145deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06));
      border-color: rgba(255,255,255,0.2);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.15),
        0 4px 12px rgba(0,0,0,0.2);
      transform: translateY(-1px);
    }
    .control-btn:active {
      transform: translateY(0) scale(0.97);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    .control-btn.active {
      background: linear-gradient(145deg, rgba(150,210,255,0.25), rgba(120,180,255,0.1));
      border-color: rgba(150,210,255,0.4);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.2),
        0 0 20px rgba(150,210,255,0.2),
        0 4px 12px rgba(0,0,0,0.15);
      color: rgba(255,255,255,0.95);
    }
    /* Image Mask Overlay */
    .image-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .image-overlay.visible {
      opacity: 1;
    }
    .image-overlay img {
      max-width: 85%;
      max-height: 85%;
      object-fit: contain;
    }
    /* Happy NY image - smaller and aligned to tree star */
    .image-overlay.happy-ny {
      align-items: flex-start;
      padding-top: 7%;
    }
    .image-overlay.happy-ny img {
      max-width: 64%;
      max-height: 64%;
    }
    /* From signature */
    .from-container {
      position: fixed;
      bottom: 6%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 60;
      text-align: center;
      pointer-events: auto;
      width: 56%;
      max-width: 800px;
      min-width: 280px;
      transition: opacity 0.4s ease-out;
    }
    .from-container.fading {
      opacity: 0 !important;
    }
    .from-wrapper {
      font-family: 'Great Vibes', cursive;
      font-size: clamp(30px, 5vw, 48px);
      color: rgba(255,235,210,0.75);
      text-shadow: 0 2px 12px rgba(0,0,0,0.5);
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      justify-content: center;
      gap: 0.2em;
      line-height: 1.3;
    }
    .from-name {
      font-family: 'Great Vibes', cursive;
      font-size: clamp(36px, 6vw, 60px);
      color: rgba(255,255,255,0.95);
      background: transparent;
      border: none;
      border-bottom: 1px solid rgba(255,255,255,0.3);
      outline: none;
      text-align: center;
      min-width: 120px;
      max-width: 100%;
      padding: 4px 12px;
      text-shadow: 0 2px 15px rgba(0,0,0,0.6), 0 0 30px rgba(255,200,100,0.3);
      transition: border-color 0.3s ease, text-shadow 0.3s ease;
      caret-color: rgba(255,220,150,0.8);
      word-wrap: break-word;
      overflow-wrap: break-word;
      display: inline-block;
    }
    .from-name:empty::before {
      content: 'Your name';
      color: rgba(255,255,255,0.35);
      font-style: italic;
    }
    .from-name:focus {
      border-bottom-color: rgba(255,220,150,0.6);
      text-shadow: 0 2px 15px rgba(0,0,0,0.6), 0 0 40px rgba(255,200,100,0.5);
    }
    .from-name:not(:empty) {
      border-bottom-color: transparent;
    }
    .from-prefix {
      cursor: text;
      transition: opacity 0.3s ease;
    }
    .from-prefix:empty {
      display: none;
    }
    /* Premium Metallic Effects - Luxury Grade with Shimmer & 3D Chrome */

    /* Shared shimmer animations */
    @keyframes shimmerSlow {
      0% { background-position: 200% 50%; }
      100% { background-position: -200% 50%; }
    }
    @keyframes shimmerMedium {
      0% { background-position: 200% 50%; }
      100% { background-position: -200% 50%; }
    }

    /* Platinum - Ultra-refined white gold, Rolex style */
    .from-wrapper.metallic-gold,
    .from-wrapper.metallic-gold .from-name,
    .from-wrapper.metallic-gold .from-prefix {
      background: linear-gradient(
        92deg,
        #b8b8b8 0%,
        #e0e0e0 8%,
        #ffffff 15%,
        #f8f8f8 22%,
        #ffffff 30%,
        #e8e8e8 38%,
        #ffffff 50%,
        #f0f0f0 62%,
        #ffffff 70%,
        #e0e0e0 80%,
        #c8c8c8 90%,
        #b8b8b8 100%
      );
      background-size: 400% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shimmerSlow 6s linear infinite;
      filter:
        drop-shadow(0 1px 0 rgba(255,255,255,0.8))
        drop-shadow(0 -1px 0 rgba(0,0,0,0.1))
        drop-shadow(0 2px 4px rgba(0,0,0,0.15))
        drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    }

    /* Liquid Chrome - Mirror polish, Rolls Royce grille */
    .from-wrapper.bimetallic,
    .from-wrapper.bimetallic .from-name,
    .from-wrapper.bimetallic .from-prefix {
      background: linear-gradient(
        95deg,
        #707070 0%,
        #a0a0a0 5%,
        #d0d0d0 10%,
        #ffffff 18%,
        #e8e8e8 25%,
        #ffffff 35%,
        #f0f0f0 45%,
        #ffffff 55%,
        #e0e0e0 65%,
        #ffffff 75%,
        #d0d0d0 85%,
        #a0a0a0 92%,
        #707070 100%
      );
      background-size: 400% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shimmerMedium 5s linear infinite;
      filter:
        drop-shadow(0 1px 0 rgba(255,255,255,0.9))
        drop-shadow(0 -1px 0 rgba(0,0,0,0.15))
        drop-shadow(0 2px 3px rgba(0,0,0,0.2))
        drop-shadow(0 4px 10px rgba(0,0,0,0.12));
    }

    /* Titanium - Apple Pro style brushed metal */
    .from-wrapper.gold-stripes,
    .from-wrapper.gold-stripes .from-name,
    .from-wrapper.gold-stripes .from-prefix {
      background: linear-gradient(
        88deg,
        #6a7078 0%,
        #8a9098 6%,
        #b0b8c0 14%,
        #d0d8e0 22%,
        #e8f0f5 32%,
        #f5f8fa 42%,
        #ffffff 50%,
        #f0f5f8 58%,
        #e0e8f0 68%,
        #c8d0d8 78%,
        #a0a8b0 88%,
        #6a7078 100%
      );
      background-size: 400% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shimmerSlow 7s linear infinite;
      filter:
        drop-shadow(0 1px 0 rgba(255,255,255,0.7))
        drop-shadow(0 -1px 0 rgba(0,0,0,0.08))
        drop-shadow(0 2px 4px rgba(0,0,0,0.12))
        drop-shadow(0 4px 8px rgba(0,0,0,0.08));
    }

    /* Champagne - Subtle warm metallic, Cartier elegance */
    .from-wrapper.chrome,
    .from-wrapper.chrome .from-name,
    .from-wrapper.chrome .from-prefix {
      background: linear-gradient(
        90deg,
        #b8b0a0 0%,
        #d8d0c0 8%,
        #f0e8dc 16%,
        #faf4ea 26%,
        #ffffff 38%,
        #fefcf8 50%,
        #ffffff 62%,
        #f8f2e8 74%,
        #e8e0d4 84%,
        #d0c8b8 92%,
        #b8b0a0 100%
      );
      background-size: 400% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shimmerSlow 8s linear infinite;
      filter:
        drop-shadow(0 1px 0 rgba(255,252,245,0.8))
        drop-shadow(0 -1px 0 rgba(0,0,0,0.06))
        drop-shadow(0 2px 4px rgba(0,0,0,0.1))
        drop-shadow(0 4px 8px rgba(0,0,0,0.08));
    }

    /* 24K Gold - Refined gold with animated shimmer */
    .from-wrapper.liquid-gold,
    .from-wrapper.liquid-gold .from-name,
    .from-wrapper.liquid-gold .from-prefix {
      background: linear-gradient(
        90deg,
        #8a6830 0%,
        #b8924a 6%,
        #d4b06a 12%,
        #f0d898 20%,
        #fff8e0 30%,
        #fffef5 42%,
        #ffffff 50%,
        #fff8e0 58%,
        #f0d898 70%,
        #d4b06a 80%,
        #b8924a 90%,
        #8a6830 100%
      );
      background-size: 400% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shimmerMedium 5s linear infinite;
      filter:
        drop-shadow(0 1px 0 rgba(255,248,220,0.9))
        drop-shadow(0 -1px 0 rgba(80,60,20,0.2))
        drop-shadow(0 2px 4px rgba(0,0,0,0.18))
        drop-shadow(0 4px 10px rgba(0,0,0,0.12));
    }

    /* Musicbar Footer - Minimalist YouTube style */
    .musicbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg,
        rgba(0,0,0,0.7) 0%,
        rgba(0,0,0,0.85) 100%);
      backdrop-filter: blur(20px) saturate(1.2);
      -webkit-backdrop-filter: blur(20px) saturate(1.2);
      border-top: 1px solid rgba(255,255,255,0.08);
      z-index: 90;
      padding: 8px 20px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font: 11px/1.4 system-ui, -apple-system, sans-serif;
      color: rgba(255,255,255,0.9);
    }
    .musicbar-progress {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.15);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }
    .musicbar-progress:hover {
      height: 6px;
    }
    .musicbar-progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ff6b6b, #ee5a5a);
      border-radius: 2px;
      transition: width 0.1s linear;
      position: relative;
    }
    .musicbar-progress:hover .musicbar-progress-bar::after {
      content: '';
      position: absolute;
      right: -6px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: #ff6b6b;
      border-radius: 50%;
    }
    .musicbar-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .musicbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-left: 0;
      transition: margin-left 0.6s cubic-bezier(0.32, 0.72, 0, 1);
    }
    .musicbar.sidebar-open .musicbar-left {
      margin-left: 220px;
    }
    .musicbar-play-btn {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      border: none;
      border-radius: 50%;
      /* 3D Sphere effect */
      background: linear-gradient(
        145deg,
        rgba(255,255,255,0.25) 0%,
        rgba(255,255,255,0.10) 30%,
        rgba(0,0,0,0.05) 60%,
        rgba(0,0,0,0.15) 100%
      );
      box-shadow:
        /* Outer glow */
        0 0 20px rgba(255,100,100,0.3),
        /* Top highlight */
        inset 0 2px 4px rgba(255,255,255,0.4),
        /* Bottom shadow */
        inset 0 -2px 6px rgba(0,0,0,0.3),
        /* Depth shadow */
        0 4px 12px rgba(0,0,0,0.4),
        /* Lift shadow */
        0 2px 4px rgba(0,0,0,0.2);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      transform: translateY(-8px);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      z-index: 10;
    }
    .musicbar-play-btn::before {
      content: '';
      position: absolute;
      top: 3px;
      left: 12px;
      right: 12px;
      height: 8px;
      background: linear-gradient(
        180deg,
        rgba(255,255,255,0.5) 0%,
        rgba(255,255,255,0) 100%
      );
      border-radius: 50%;
    }
    .musicbar-play-btn:hover {
      transform: translateY(-10px) scale(1.08);
      box-shadow:
        0 0 30px rgba(255,100,100,0.5),
        inset 0 2px 4px rgba(255,255,255,0.5),
        inset 0 -2px 6px rgba(0,0,0,0.3),
        0 6px 20px rgba(0,0,0,0.5),
        0 2px 4px rgba(0,0,0,0.2);
    }
    .musicbar-play-btn:active {
      transform: translateY(-4px) scale(0.98);
    }
    .musicbar-play-btn svg {
      width: 24px;
      height: 24px;
      fill: rgba(255,255,255,0.95);
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
      position: relative;
      z-index: 1;
    }
    .musicbar-skip-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      opacity: 0.7;
      transition: opacity 0.15s ease;
    }
    .musicbar-skip-btn:hover {
      opacity: 1;
    }
    .musicbar-skip-btn svg {
      width: 20px;
      height: 20px;
      fill: rgba(255,255,255,0.9);
    }
    .musicbar-time {
      font-size: 11px;
      color: rgba(255,255,255,0.6);
      font-variant-numeric: tabular-nums;
      min-width: 90px;
    }
    .musicbar-time-current {
      color: rgba(255,255,255,0.9);
    }
    .musicbar-center {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 0;
    }
    .musicbar-track-info {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 4px 12px;
      border-radius: 4px;
      transition: background 0.2s ease;
      max-width: 300px;
    }
    .musicbar-track-info:hover {
      background: rgba(255,255,255,0.1);
    }
    .musicbar-track-name {
      font-size: 13px;
      font-weight: 500;
      color: rgba(255,255,255,0.95);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .musicbar-track-chevron {
      width: 16px;
      height: 16px;
      fill: rgba(255,255,255,0.5);
      flex-shrink: 0;
      transition: transform 0.2s ease;
    }
    .musicbar-track-info:hover .musicbar-track-chevron {
      fill: rgba(255,255,255,0.8);
    }
    .musicbar.tracklist-open .musicbar-track-chevron {
      transform: rotate(180deg);
    }
    .musicbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .musicbar-icon-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      opacity: 0.6;
      transition: opacity 0.15s ease;
    }
    .musicbar-icon-btn:hover {
      opacity: 1;
    }
    .musicbar-icon-btn svg {
      width: 18px;
      height: 18px;
      fill: rgba(255,255,255,0.9);
    }
    /* Track list dropdown */
    .musicbar-tracklist {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20,20,25,0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 8px;
      min-width: 220px;
      box-shadow: 0 -8px 32px rgba(0,0,0,0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    .musicbar.tracklist-open .musicbar-tracklist {
      opacity: 1;
      visibility: visible;
    }
    .musicbar-tracklist-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .musicbar-tracklist-item:hover {
      background: rgba(255,255,255,0.08);
    }
    .musicbar-tracklist-item.playing {
      background: rgba(255,107,107,0.15);
    }
    .musicbar-tracklist-num {
      font-size: 11px;
      color: rgba(255,255,255,0.4);
      width: 16px;
      text-align: center;
    }
    .musicbar-tracklist-item.playing .musicbar-tracklist-num {
      color: #ff6b6b;
    }
    .musicbar-tracklist-name {
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      flex: 1;
    }
    .musicbar-tracklist-item.playing .musicbar-tracklist-name {
      color: #ff6b6b;
      font-weight: 500;
    }
    .musicbar-tracklist-playing-icon {
      width: 14px;
      height: 14px;
      fill: #ff6b6b;
      display: none;
    }
    .musicbar-tracklist-item.playing .musicbar-tracklist-playing-icon {
      display: block;
    }
    :fullscreen .musicbar {
      opacity: 0 !important;
      pointer-events: none !important;
    }
    :-webkit-full-screen .musicbar {
      opacity: 0 !important;
      pointer-events: none !important;
    }
    /* Music Modal */
    .music-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .music-modal.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .music-modal-content {
      background: linear-gradient(165deg,
        rgba(40,40,55,0.92) 0%,
        rgba(25,25,35,0.95) 100%);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 28px;
      max-width: 400px;
      width: 90%;
      box-shadow:
        0 25px 80px rgba(0,0,0,0.6),
        0 0 1px rgba(255,255,255,0.1),
        inset 0 1px 0 rgba(255,255,255,0.1);
      backdrop-filter: blur(20px) saturate(1.3);
      -webkit-backdrop-filter: blur(20px) saturate(1.3);
    }
    .music-modal-content h3 {
      margin: 0 0 8px 0;
      color: rgba(255,255,255,0.9);
      font-size: 16px;
      font-weight: 500;
    }
    .music-modal-content p {
      margin: 0 0 16px 0;
      color: rgba(255,255,255,0.5);
      font-size: 12px;
    }
    .music-url-inputs {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
    }
    .music-url-inputs label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      color: rgba(255,255,255,0.6);
      font-size: 11px;
    }
    .music-url-inputs input {
      padding: 8px 10px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      color: rgba(255,255,255,0.9);
      font-size: 11px;
      outline: none;
      transition: border-color 0.2s ease;
    }
    .music-url-inputs input:focus {
      border-color: rgba(180,220,255,0.5);
    }
    .music-modal-btns {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    /* Views counter */
    .views-counter {
      position: fixed;
      bottom: 70px;
      right: 16px;
      font: 11px/1.4 system-ui, -apple-system, sans-serif;
      color: rgba(255,255,255,0.4);
      z-index: 5;
      user-select: none;
      pointer-events: none;
    }
    /* Fullscreen: pure art mode */
    :fullscreen .sidebar,
    :fullscreen .hint,
    :fullscreen .views-counter {
      opacity: 0 !important;
      pointer-events: none !important;
      transition: opacity 0.4s ease;
    }
    :-webkit-full-screen .sidebar,
    :-webkit-full-screen .hint,
    :-webkit-full-screen .views-counter {
      opacity: 0 !important;
      pointer-events: none !important;
      transition: opacity 0.4s ease;
    }
    /* Hotkey Help Overlay */
    .hotkey-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index: 300;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .hotkey-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .hotkey-content {
      text-align: center;
      transform: scale(0.95) translateY(10px);
      transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .hotkey-overlay.visible .hotkey-content {
      transform: scale(1) translateY(0);
    }
    .hotkey-title {
      font-size: 14px;
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 3px;
      margin-bottom: 30px;
    }
    .hotkey-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px 40px;
      max-width: 500px;
    }
    .hotkey-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
    }
    .hotkey-key {
      min-width: 44px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      font-family: system-ui, -apple-system, sans-serif;
      font-size: 13px;
      font-weight: 600;
      color: rgba(255,255,255,0.9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
      padding: 0 10px;
    }
    .hotkey-desc {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      text-align: left;
    }
    .hotkey-dismiss {
      margin-top: 30px;
      font-size: 11px;
      color: rgba(255,255,255,0.35);
    }
    /* Font size indicator */
    .font-size-indicator {
      position: fixed;
      bottom: 50%;
      right: 20px;
      transform: translateY(50%);
      background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 8px 14px;
      font-size: 12px;
      color: rgba(255,255,255,0.8);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.22, 1, 0.36, 1);
      z-index: 150;
    }
    .font-size-indicator.visible {
      opacity: 1;
      transform: translateY(50%) scale(1);
    }
    .font-size-indicator.hiding {
      opacity: 0;
      transform: translateY(50%) scale(0.9);
    }
    /* Fullscreen corner button - centered above views counter */
    .fullscreen-btn-corner {
      position: fixed;
      bottom: 90px;
      right: 16px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      cursor: pointer;
      z-index: 95;
      transition: all 0.25s ease;
    }
    .fullscreen-btn-corner:hover {
      background: linear-gradient(145deg, rgba(255,255,255,0.18), rgba(255,255,255,0.08));
      border-color: rgba(255,255,255,0.25);
      transform: scale(1.1);
    }
    .fullscreen-btn-corner svg {
      width: 18px;
      height: 18px;
      stroke: rgba(255,255,255,0.75);
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    :fullscreen .fullscreen-btn-corner,
    :-webkit-full-screen .fullscreen-btn-corner {
      opacity: 0 !important;
      pointer-events: none !important;
    }
    /* Random dice button - icy glass cube (50% transparent) */
    .random-btn {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg,
        rgba(180,220,255,0.10) 0%,
        rgba(150,200,255,0.04) 50%,
        rgba(200,230,255,0.06) 100%);
      backdrop-filter: blur(12px) saturate(1.4);
      -webkit-backdrop-filter: blur(12px) saturate(1.4);
      border: 1px solid rgba(200,230,255,0.12);
      border-radius: 10px;
      cursor: pointer;
      z-index: 95;
      transition: all 0.25s ease;
      opacity: 0.5;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.15),
        inset 0 -1px 0 rgba(100,150,200,0.05),
        0 4px 16px rgba(100,150,200,0.08),
        0 0 1px rgba(255,255,255,0.2);
    }
    .random-btn svg {
      filter: drop-shadow(0 1px 2px rgba(100,180,220,0.2));
      opacity: 0.7;
    }
    .random-btn:hover {
      opacity: 0.9;
      background: linear-gradient(145deg,
        rgba(180,220,255,0.15) 0%,
        rgba(160,210,255,0.08) 50%,
        rgba(210,235,255,0.10) 100%);
      border-color: rgba(200,230,255,0.2);
      transform: scale(1.1);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.2),
        inset 0 -1px 0 rgba(100,150,200,0.08),
        0 6px 24px rgba(100,150,200,0.12),
        0 0 20px rgba(150,200,255,0.06);
    }
    .random-btn.shake {
      animation: diceShake 0.5s ease-out;
    }
    @keyframes diceShake {
      0%, 100% { transform: rotate(0deg) scale(1); }
      15% { transform: rotate(-15deg) scale(1.15); }
      30% { transform: rotate(10deg) scale(1.1); }
      45% { transform: rotate(-10deg) scale(1.1); }
      60% { transform: rotate(8deg) scale(1.05); }
      75% { transform: rotate(-5deg) scale(1.02); }
      90% { transform: rotate(3deg) scale(1); }
    }
    :fullscreen .random-btn,
    :-webkit-full-screen .random-btn {
      opacity: 0 !important;
      pointer-events: none !important;
    }
    /* Visitor leaderboard */
    .visitor-leaderboard {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      max-width: 85%;
      z-index: 80;
      padding: 10px 18px;
      background: linear-gradient(145deg, rgba(255,255,255,0.10), rgba(255,255,255,0.03));
      backdrop-filter: blur(16px) saturate(1.3);
      -webkit-backdrop-filter: blur(16px) saturate(1.3);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 24px;
      opacity: 0;
      transition: opacity 0.6s ease;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
    }
    .visitor-leaderboard.visible {
      opacity: 0.75;
    }
    .visitor-leaderboard:empty {
      display: none;
    }
    .leaderboard-entry {
      display: flex;
      align-items: center;
      gap: 3px;
      padding: 3px 8px 3px 5px;
      background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      animation: entryPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      opacity: 0;
      transform: scale(0.8) translateY(-10px);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .leaderboard-entry:hover {
      transform: scale(1.08);
      box-shadow: 0 4px 16px rgba(255,200,100,0.15);
    }
    .leaderboard-entry.gold {
      background: linear-gradient(135deg, rgba(255,215,0,0.25), rgba(255,180,0,0.10));
      border-color: rgba(255,215,0,0.3);
      box-shadow: 0 0 12px rgba(255,215,0,0.2);
    }
    .leaderboard-entry.silver {
      background: linear-gradient(135deg, rgba(192,192,192,0.20), rgba(160,160,160,0.08));
      border-color: rgba(192,192,192,0.25);
    }
    .leaderboard-entry.bronze {
      background: linear-gradient(135deg, rgba(205,127,50,0.20), rgba(180,100,30,0.08));
      border-color: rgba(205,127,50,0.25);
    }
    .entry-flag {
      font-size: 16px;
      filter: drop-shadow(0 1px 3px rgba(0,0,0,0.3));
    }
    .entry-count {
      font-family: system-ui, -apple-system, sans-serif;
      font-size: 11px;
      font-weight: 600;
      color: rgba(255,255,255,0.8);
      text-shadow: 0 1px 2px rgba(0,0,0,0.4);
      min-width: 16px;
      text-align: center;
    }
    @keyframes entryPop {
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    /* Instant tooltip */
    .leaderboard-entry {
      position: relative;
    }
    .leaderboard-entry::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%) scale(0.9);
      padding: 4px 8px;
      background: rgba(0,0,0,0.85);
      color: rgba(255,255,255,0.95);
      font-family: Arial, sans-serif;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      border-radius: 6px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.05s ease, transform 0.1s ease;
      z-index: 100;
    }
    .leaderboard-entry:hover::after {
      opacity: 1;
      transform: translateX(-50%) scale(1);
    }
    :fullscreen .visitor-leaderboard,
    :-webkit-full-screen .visitor-leaderboard {
      opacity: 0 !important;
      pointer-events: none !important;
    }

    /* ==================== MOBILE STYLES ==================== */
    @media screen and (max-width: 768px) {
      /* Hide sidebar completely on mobile */
      .sidebar {
        display: none !important;
      }

      /* Remove sidebar margin from musicbar */
      .musicbar.sidebar-open .musicbar-left {
        margin-left: 0;
      }

      /* Visitor leaderboard - mobile optimized */
      .visitor-leaderboard {
        top: 12px;
        padding: 8px 12px;
        gap: 6px;
        max-width: 92%;
        border-radius: 20px;
      }
      .leaderboard-entry {
        padding: 2px 6px 2px 4px;
        gap: 2px;
        border-radius: 12px;
      }
      .entry-flag {
        font-size: 14px;
      }
      .entry-count {
        font-size: 10px;
      }
      /* Disable hover tooltip on mobile (use tap instead) */
      .leaderboard-entry::after {
        display: none;
      }

      /* From signature - mobile proportions */
      .from-container {
        bottom: 15%;
        width: 90%;
        min-width: unset;
        padding: 0 12px;
      }
      .from-wrapper {
        font-size: clamp(24px, 6vw, 36px);
        gap: 0.15em;
      }
      .from-name {
        font-size: clamp(28px, 7vw, 44px);
        min-width: 80px;
        padding: 3px 8px;
      }

      /* Musicbar - simplified mobile version */
      .musicbar {
        padding: 6px 12px;
        gap: 4px;
      }
      .musicbar-progress {
        height: 3px;
      }
      .musicbar-progress:hover {
        height: 3px;
      }
      .musicbar-controls {
        gap: 8px;
      }
      .musicbar-left {
        gap: 8px;
        margin-left: 0 !important;
      }
      .musicbar-play-btn {
        width: 44px;
        height: 44px;
        transform: translateY(-6px);
      }
      .musicbar-play-btn:hover {
        transform: translateY(-8px) scale(1.05);
      }
      .musicbar-play-btn svg {
        width: 20px;
        height: 20px;
      }
      .musicbar-skip-btn {
        width: 24px;
        height: 24px;
        padding: 4px;
      }
      .musicbar-time {
        font-size: 10px;
        min-width: 60px;
      }
      .musicbar-center {
        flex: 1;
        min-width: 0;
      }
      .musicbar-track-info {
        padding: 4px 8px;
      }
      .musicbar-track-name {
        font-size: 11px;
        max-width: 100px;
      }
      .musicbar-right {
        gap: 4px;
      }
      .musicbar-icon-btn {
        width: 28px;
        height: 28px;
        padding: 5px;
      }
      .musicbar-tracklist {
        bottom: calc(100% + 6px);
        right: 8px;
        max-width: calc(100vw - 16px);
        max-height: 50vh;
      }

      /* Hide hint on mobile */
      .hint {
        display: none;
      }

      /* Random button - mobile position */
      .random-btn {
        right: 12px;
        bottom: 80px;
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
    }

    /* Extra small screens (phones in portrait) */
    @media screen and (max-width: 480px) {
      .visitor-leaderboard {
        top: 8px;
        padding: 6px 10px;
        gap: 4px;
      }
      .leaderboard-entry {
        padding: 2px 5px 2px 3px;
      }
      .entry-flag {
        font-size: 12px;
      }
      .entry-count {
        font-size: 9px;
        min-width: 14px;
      }

      .from-container {
        bottom: 18%;
      }
      .from-wrapper {
        font-size: clamp(20px, 5.5vw, 30px);
      }
      .from-name {
        font-size: clamp(24px, 6.5vw, 36px);
        min-width: 60px;
      }

      .musicbar-time {
        display: none;
      }
      .musicbar-track-name {
        max-width: 80px;
      }
      .musicbar-skip-btn {
        display: none;
      }
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
<canvas id="c"></canvas>
<div class="visitor-leaderboard" id="visitorLeaderboard"></div>
<div class="snow-container" id="snow"></div>
<div class="image-overlay visible" id="imageOverlay">
  <img src="img/Merry Xmas.png" alt="Merry Christmas">
</div>

<div class="from-container">
  <div class="from-wrapper">
    <span class="from-prefix" id="fromPrefix" contenteditable="true" spellcheck="false">From:</span>
    <span class="from-name" id="fromInput" contenteditable="true" spellcheck="false"></span>
  </div>
</div>

<aside class="sidebar" id="sidebar">
  <button class="sidebar-toggle" id="sidebarToggle">
    <svg class="chevron-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="9 18 15 12 9 6"/>
    </svg>
    <span>Controls</span>
  </button>

  <div class="sidebar-section">
    <!-- Snow Density -->
    <div class="control-group">
      <div class="control-icon">
        <svg viewBox="0 0 24 24"><path d="M12 2v20M2 12h20M4.93 4.93l14.14 14.14M19.07 4.93L4.93 19.07"/></svg>
      </div>
      <div class="control-content">
        <div class="control-label">Snow Density</div>
        <div class="control-row">
          <input type="range" id="snowDensity" min="20" max="200" value="110">
          <span class="control-value" id="densityVal">110</span>
        </div>
      </div>
    </div>

    <!-- Snow Speed -->
    <div class="control-group">
      <div class="control-icon">
        <svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      </div>
      <div class="control-content">
        <div class="control-label">Fall Speed</div>
        <div class="control-row">
          <input type="range" id="snowSpeed" min="2" max="15" value="2" step="0.5">
          <span class="control-value" id="speedVal">2s</span>
        </div>
      </div>
    </div>

    <!-- Sparkle -->
    <div class="control-group">
      <div class="control-icon">
        <svg viewBox="0 0 24 24"><path d="M12 3l1.5 5.5L19 10l-5.5 1.5L12 17l-1.5-5.5L5 10l5.5-1.5L12 3zM5 19l1 3 1-3 3-1-3-1-1-3-1 3-3 1 3 1z"/></svg>
      </div>
      <div class="control-content">
        <div class="control-label">Tree Sparkle</div>
        <div class="control-row">
          <input type="range" id="sparkleCtrl" min="0.2" max="3" value="3" step="0.1">
          <span class="control-value" id="sparkleVal">3.0</span>
        </div>
      </div>
    </div>
  </div>

  <div class="sidebar-section">
    <!-- Toggle Snow -->
    <div class="control-group">
      <div class="control-icon">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
      </div>
      <div class="control-content">
        <button class="control-btn active" id="toggleSnow">Snow On</button>
      </div>
    </div>

    <!-- Image Overlay -->
    <div class="control-group">
      <div class="control-icon">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
      </div>
      <div class="control-content">
        <button class="control-btn active" id="toggleImage">Image On</button>
      </div>
    </div>

    <!-- Fullscreen -->
    <div class="control-group">
      <div class="control-icon">
        <svg viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 00-2 2v3M21 8V5a2 2 0 00-2-2h-3M3 16v3a2 2 0 002 2h3M16 21h3a2 2 0 002-2v-3"/></svg>
      </div>
      <div class="control-content">
        <button class="control-btn" id="toggleFullscreen">Fullscreen</button>
      </div>
    </div>

    <!-- Font Size -->
    <div class="control-group">
      <div class="control-icon">
        <svg viewBox="0 0 24 24"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>
      </div>
      <div class="control-content">
        <button class="control-btn" id="fontSizeBtn">Text Size: 100%</button>
      </div>
    </div>

    <!-- Font Texture -->
    <div class="control-group">
      <div class="control-icon">
        <svg viewBox="0 0 24 24"><path d="M12 3v18M3 12h18M5.5 5.5l13 13M18.5 5.5l-13 13"/></svg>
      </div>
      <div class="control-content">
        <button class="control-btn" id="fontTextureBtn">Texture: Regular</button>
      </div>
    </div>

    <!-- Toggle Text Visibility -->
    <div class="control-group">
      <div class="control-icon">
        <svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
      </div>
      <div class="control-content">
        <button class="control-btn active" id="toggleText">Text On</button>
      </div>
    </div>

    <!-- Restore Text -->
    <div class="control-group">
      <div class="control-icon">
        <svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
      </div>
      <div class="control-content">
        <button class="control-btn" id="restoreSignature">Restore Text</button>
      </div>
    </div>
  </div>
</aside>

<!-- Musicbar Footer - YouTube style -->
<div class="musicbar" id="musicbar">
  <div class="musicbar-progress" id="musicbarProgress">
    <div class="musicbar-progress-bar" id="musicbarProgressBar"></div>
  </div>
  <div class="musicbar-controls">
    <div class="musicbar-left">
      <button class="musicbar-skip-btn" id="prevTrack" title="Previous">
        <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
      </button>
      <button class="musicbar-play-btn" id="playPauseBtn" title="Play">
        <svg viewBox="0 0 24 24" id="playIcon"><polygon points="5,3 19,12 5,21"/></svg>
        <svg viewBox="0 0 24 24" id="pauseIcon" style="display:none"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
      </button>
      <button class="musicbar-skip-btn" id="nextTrack" title="Next">
        <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
      </button>
      <div class="musicbar-time">
        <span class="musicbar-time-current" id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
      </div>
    </div>
    <div class="musicbar-center">
      <div class="musicbar-track-info" id="trackInfo">
        <span class="musicbar-track-name" id="currentTrackName">Select a track</span>
        <svg class="musicbar-track-chevron" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
      </div>
    </div>
    <div class="musicbar-right">
      <button class="musicbar-icon-btn" id="editMusicUrls" title="Edit URLs">
        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
      </button>
    </div>
  </div>
  <!-- Track list dropdown -->
  <div class="musicbar-tracklist" id="tracklistDropdown">
    <div class="musicbar-tracklist-item" data-track="0">
      <span class="musicbar-tracklist-num">1</span>
      <span class="musicbar-tracklist-name">Carol of the Bells</span>
      <svg class="musicbar-tracklist-playing-icon" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
    </div>
    <div class="musicbar-tracklist-item" data-track="1">
      <span class="musicbar-tracklist-num">2</span>
      <span class="musicbar-tracklist-name">Silent Night</span>
      <svg class="musicbar-tracklist-playing-icon" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
    </div>
    <div class="musicbar-tracklist-item" data-track="2">
      <span class="musicbar-tracklist-num">3</span>
      <span class="musicbar-tracklist-name">O Holy Night</span>
      <svg class="musicbar-tracklist-playing-icon" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
    </div>
    <div class="musicbar-tracklist-item" data-track="3">
      <span class="musicbar-tracklist-num">4</span>
      <span class="musicbar-tracklist-name">Jingle Bells</span>
      <svg class="musicbar-tracklist-playing-icon" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
    </div>
    <div class="musicbar-tracklist-item" data-track="4">
      <span class="musicbar-tracklist-num">5</span>
      <span class="musicbar-tracklist-name">Winter Wonderland</span>
      <svg class="musicbar-tracklist-playing-icon" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
    </div>
    <div class="musicbar-tracklist-item" data-track="5">
      <span class="musicbar-tracklist-num">6</span>
      <span class="musicbar-tracklist-name">Christmas Medley</span>
      <svg class="musicbar-tracklist-playing-icon" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
    </div>
  </div>
</div>

<!-- Music URL Editor Modal -->
<div class="music-modal" id="musicModal">
  <div class="music-modal-content">
    <h3>Customize Music URLs</h3>
    <p>Paste YouTube video URLs:</p>
    <div class="music-url-inputs">
      <label>Track 1: <input type="text" id="musicUrl0" placeholder="YouTube URL"></label>
      <label>Track 2: <input type="text" id="musicUrl1" placeholder="YouTube URL"></label>
      <label>Track 3: <input type="text" id="musicUrl2" placeholder="YouTube URL"></label>
      <label>Track 4: <input type="text" id="musicUrl3" placeholder="YouTube URL"></label>
      <label>Track 5: <input type="text" id="musicUrl4" placeholder="YouTube URL"></label>
      <label>Track 6: <input type="text" id="musicUrl5" placeholder="YouTube URL"></label>
    </div>
    <div class="music-modal-btns">
      <button class="control-btn" id="saveMusicUrls">Save</button>
      <button class="control-btn" id="closeMusicModal">Cancel</button>
    </div>
  </div>
</div>

<!-- Hidden YouTube Players -->
<div id="ytPlayers" style="position:fixed;bottom:0;right:0;width:200px;height:200px;overflow:hidden;opacity:0.001;pointer-events:none;z-index:-1;"></div>

<!-- Hotkey Help Overlay -->
<div class="hotkey-overlay" id="hotkeyOverlay">
  <div class="hotkey-content">
    <div class="hotkey-title">Keyboard Shortcuts</div>
    <div class="hotkey-grid">
      <div class="hotkey-item"><span class="hotkey-key">F</span><span class="hotkey-desc">Toggle fullscreen</span></div>
      <div class="hotkey-item"><span class="hotkey-key">S</span><span class="hotkey-desc">Toggle snow</span></div>
      <div class="hotkey-item"><span class="hotkey-key">C</span><span class="hotkey-desc">Toggle controls</span></div>
      <div class="hotkey-item"><span class="hotkey-key">M</span><span class="hotkey-desc">Toggle music</span></div>
      <div class="hotkey-item"><span class="hotkey-key">I</span><span class="hotkey-desc">Toggle image overlay</span></div>
      <div class="hotkey-item"><span class="hotkey-key">T</span><span class="hotkey-desc">Cycle font size</span></div>
      <div class="hotkey-item"><span class="hotkey-key">1-6</span><span class="hotkey-desc">Play music track</span></div>
      <div class="hotkey-item"><span class="hotkey-key">+ </span><span class="hotkey-desc">Adjust sparkle</span></div>
      <div class="hotkey-item"><span class="hotkey-key">?</span><span class="hotkey-desc">Show this help</span></div>
      <div class="hotkey-item"><span class="hotkey-key">Esc</span><span class="hotkey-desc">Close / Exit</span></div>
    </div>
    <div class="hotkey-dismiss">Press any key to dismiss</div>
  </div>
</div>

<!-- Font Size Indicator -->
<div class="font-size-indicator" id="fontSizeIndicator">100%</div>

<div class="hint">Press [?] for keyboard shortcuts</div>
<div class="views-counter"><span id="viewCount"></span> views</div>

<!-- Fullscreen button (bottom-right) -->
<button class="fullscreen-btn-corner" id="fullscreenCorner" title="Fullscreen">
  <svg viewBox="0 0 24 24"><path d="M8 3H5a2 2 0 00-2 2v3M21 8V5a2 2 0 00-2-2h-3M3 16v3a2 2 0 002 2h3M16 21h3a2 2 0 002-2v-3"/></svg>
</button>

<!-- Random settings button (top-right) - Ice cube dice -->
<button class="random-btn" id="randomBtn" title="Randomize a setting">
  <svg width="32" height="32" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="iceSurfaceGrad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.6" />
        <stop offset="50%" style="stop-color:#d0f5ff;stop-opacity:0.4" />
        <stop offset="100%" style="stop-color:#a0e0f0;stop-opacity:0.5" />
      </linearGradient>
      <linearGradient id="iceDeepGrad" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" style="stop-color:#d0f5ff;stop-opacity:0.3" />
        <stop offset="100%" style="stop-color:#80d0e0;stop-opacity:0.4" />
      </linearGradient>
      <radialGradient id="pipGrad" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
        <stop offset="50%" style="stop-color:#ffffff;stop-opacity:0.1" />
        <stop offset="100%" style="stop-color:#c0efff;stop-opacity:0.6" />
      </radialGradient>
      <filter id="frostedIceFilter" x="-20%" y="-20%" width="140%" height="140%">
        <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="4" result="noise" />
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="3" xChannelSelector="R" yChannelSelector="G" result="displaced" />
        <feGaussianBlur in="displaced" stdDeviation="0.5" result="blurredFrost" />
        <feMerge>
          <feMergeNode in="SourceGraphic" opacity="0.5"/>
          <feMergeNode in="blurredFrost" opacity="1"/>
        </feMerge>
      </filter>
      <filter id="softGlow">
        <feGaussianBlur stdDeviation="8" result="coloredBlur"/>
      </filter>
    </defs>
    <g transform="translate(75, 50)">
      <ellipse cx="125" cy="230" rx="100" ry="30" fill="#a0e0f0" opacity="0.4" filter="url(#softGlow)" />
      <path d="M0 125 L125 187.5 L250 125" fill="none" stroke="#ffffff" stroke-width="1" stroke-opacity="0.3" stroke-dasharray="5,5"/>
      <path d="M125 187.5 L125 62.5" fill="none" stroke="#ffffff" stroke-width="1" stroke-opacity="0.3" stroke-dasharray="5,5"/>
      <g stroke="#ffffff" stroke-width="3" stroke-opacity="0.8" filter="url(#frostedIceFilter)">
        <path d="M125 0 L250 62.5 L125 125 L0 62.5 Z" fill="url(#iceSurfaceGrad)" />
        <path d="M0 62.5 L125 125 L125 250 L0 187.5 Z" fill="url(#iceDeepGrad)" />
        <path d="M125 125 L250 62.5 L250 187.5 L125 250 Z" fill="url(#iceDeepGrad)" />
      </g>
      <g fill="none" stroke="#ffffff" stroke-width="4" stroke-opacity="0.9" stroke-linecap="round">
        <path d="M5 62.5 L125 5 L245 62.5" opacity="0.8"/>
        <path d="M125 127 L125 248" opacity="0.6"/>
      </g>
      <g fill="url(#pipGrad)" stroke="#ffffff" stroke-width="1.5" stroke-opacity="0.6">
        <circle cx="125" cy="62.5" r="18" />
        <circle cx="45" cy="115" r="14" />
        <circle cx="80" cy="200" r="14" />
        <circle cx="170" cy="115" r="14" />
        <circle cx="187.5" cy="156.25" r="14" />
        <circle cx="205" cy="200" r="14" />
      </g>
    </g>
  </svg>
</button>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha: false });

  // Offscreen buffer for bloom
  const glow = document.createElement('canvas');
  const gtx = glow.getContext('2d', { alpha: true });

  const cfg = {
    sparkle: 3.0,
    quality: 1.0,
    warm: { r: 255, g: 210, b: 120 },
    gold: { r: 255, g: 195, b: 90  },
    amber:{ r: 255, g: 170, b: 70  }
  };

  // ===== NEW YEAR MODE =====
  const MODE = {
    TREE: 'tree',
    MORPH_TO_FIREWORKS: 'morphToFireworks',
    FIREWORKS: 'fireworks',
    MORPH_TO_2026: 'morphTo2026',
    NEW_YEAR: 'newYear'
  };

  let currentMode = MODE.TREE;
  let modeStartTime = 0;
  let hasSeenTreeMorph = false; // Only show treefireworks once per session
  const nyStars = []; // The 26 stars from exploding star

  // Check if we should be in New Year mode (Dec 27+ or January)
  function isNewYearPeriod() {
    const now = new Date();
    const month = now.getMonth();
    const day = now.getDate();
    return (month === 11 && day >= 27) || month === 0; // Dec 27+ or January
  }

  // Generate "2026" digit positions (normalized 0-1 coordinates)
  function generate2026Positions() {
    const positions = [];
    const digits = ['2', '0', '2', '6'];
    const digitWidth = 0.12;
    const spacing = 0.04;
    const totalWidth = digits.length * digitWidth + (digits.length - 1) * spacing;
    const startX = 0.5 - totalWidth / 2;
    const centerY = 0.5;
    const digitHeight = 0.35;

    // Simple 7-segment style digit patterns
    const patterns = {
      '2': [[0,0],[1,0],[1,0.5],[0,0.5],[0,1],[1,1]], // top, right-top, middle, left-bottom, bottom
      '0': [[0,0],[1,0],[1,1],[0,1],[0,0]], // rectangle outline
      '6': [[1,0],[0,0],[0,1],[1,1],[1,0.5],[0,0.5]]
    };

    digits.forEach((digit, di) => {
      const baseX = startX + di * (digitWidth + spacing);
      const pointsPerDigit = 80;

      // Create points along digit outline
      for (let i = 0; i < pointsPerDigit; i++) {
        const u = i / pointsPerDigit;
        let x, y;

        if (digit === '2') {
          // Draw "2" shape
          if (u < 0.2) { x = baseX + u * 5 * digitWidth; y = centerY - digitHeight/2; }
          else if (u < 0.35) { x = baseX + digitWidth; y = centerY - digitHeight/2 + (u - 0.2) * 3.33 * digitHeight/2; }
          else if (u < 0.5) { x = baseX + digitWidth - (u - 0.35) * 6.67 * digitWidth; y = centerY; }
          else if (u < 0.7) { x = baseX; y = centerY + (u - 0.5) * 2.5 * digitHeight/2; }
          else { x = baseX + (u - 0.7) * 3.33 * digitWidth; y = centerY + digitHeight/2; }
        } else if (digit === '0') {
          // Draw "0" as ellipse
          const angle = u * Math.PI * 2;
          x = baseX + digitWidth/2 + Math.cos(angle) * digitWidth/2;
          y = centerY + Math.sin(angle) * digitHeight/2;
        } else if (digit === '6') {
          // Draw "6" shape
          if (u < 0.15) { x = baseX + digitWidth - u * 6.67 * digitWidth; y = centerY - digitHeight/2; }
          else if (u < 0.4) { x = baseX; y = centerY - digitHeight/2 + (u - 0.15) * 4 * digitHeight; }
          else if (u < 0.6) { x = baseX + (u - 0.4) * 5 * digitWidth; y = centerY + digitHeight/2; }
          else if (u < 0.8) { x = baseX + digitWidth; y = centerY + digitHeight/2 - (u - 0.6) * 2.5 * digitHeight/2; }
          else { x = baseX + digitWidth - (u - 0.8) * 5 * digitWidth; y = centerY; }
        }

        positions.push({
          x: x + (Math.random() - 0.5) * 0.015,
          y: y + (Math.random() - 0.5) * 0.015
        });
      }
    });

    return positions;
  }

  // Generate inverted-U arch positions for 26 stars
  function generate26StarPositions() {
    const positions = [];
    for (let i = 0; i < 26; i++) {
      const u = i / 25;
      // Inverted U: left side -> top -> right side
      const angle = Math.PI + u * Math.PI; // PI to 2*PI
      const radiusX = 0.38;
      const radiusY = 0.32;
      positions.push({
        x: 0.5 + Math.cos(angle) * radiusX,
        y: 0.25 + Math.sin(angle) * radiusY * 0.7
      });
    }
    return positions;
  }

  const target2026 = generate2026Positions();
  const targetStarArch = generate26StarPositions();

  // Transition to a new mode
  function transitionToMode(newMode) {
    currentMode = newMode;
    modeStartTime = performance.now();

    if (newMode === MODE.MORPH_TO_FIREWORKS) {
      // Give each light a random outward velocity
      lights.forEach(L => {
        const dx = L.x - 0.5;
        const dy = L.y - 0.5;
        const dist = Math.sqrt(dx*dx + dy*dy) || 0.01;
        L.vx = (dx / dist) * (0.3 + Math.random() * 0.4);
        L.vy = (dy / dist) * (0.3 + Math.random() * 0.4) - 0.2; // upward bias
        L.originalX = L.x;
        L.originalY = L.y;
      });

      // Explode star into 26 mini stars
      nyStars.length = 0;
      const starLight = lights.find(L => L.star);
      if (starLight) {
        for (let i = 0; i < 26; i++) {
          const angle = (i / 26) * Math.PI * 2;
          nyStars.push({
            x: starLight.x,
            y: starLight.y,
            tx: targetStarArch[i].x,
            ty: targetStarArch[i].y,
            vx: Math.cos(angle) * 0.3,
            vy: Math.sin(angle) * 0.3 - 0.2,
            r: 0.006,
            phase: Math.random() * Math.PI * 2,
            colour: {r:255, g:245, b:210}
          });
        }
      }
    }

    if (newMode === MODE.MORPH_TO_2026) {
      // Assign each light a target position in "2026"
      const shuffled = [...target2026].sort(() => Math.random() - 0.5);
      lights.forEach((L, i) => {
        const target = shuffled[i % shuffled.length];
        L.tx = target.x;
        L.ty = target.y;
      });
      // Stars move to arch positions
      nyStars.forEach((s, i) => {
        s.tx = targetStarArch[i].x;
        s.ty = targetStarArch[i].y;
      });
    }

    if (newMode === MODE.NEW_YEAR) {
      hasSeenTreeMorph = true;
      scheduleNextFireworks();
    }

    if (newMode === MODE.FIREWORKS && hasSeenTreeMorph) {
      // Re-scatter particles for fireworks burst
      lights.forEach(L => {
        const dx = L.x - 0.5;
        const dy = L.y - 0.3;
        const dist = Math.sqrt(dx*dx + dy*dy) || 0.01;
        L.vx = (dx / dist) * (0.2 + Math.random() * 0.3);
        L.vy = (dy / dist) * (0.2 + Math.random() * 0.3) - 0.15;
      });
      nyStars.forEach(s => {
        const angle = Math.random() * Math.PI * 2;
        s.vx = Math.cos(angle) * 0.25;
        s.vy = Math.sin(angle) * 0.25 - 0.1;
      });
    }
  }

  // Schedule next fireworks burst (random 8-20 seconds)
  let fireworksTimeout = null;
  function scheduleNextFireworks() {
    if (fireworksTimeout) clearTimeout(fireworksTimeout);
    const delay = 8000 + Math.random() * 12000;
    fireworksTimeout = setTimeout(() => {
      if (currentMode === MODE.NEW_YEAR) {
        transitionToMode(MODE.FIREWORKS);
      }
    }, delay);
  }

  let W = 0, H = 0, dpr = Math.min(2, window.devicePixelRatio || 1);
  let t0 = performance.now();

  const rand = (a=1, b=0) => Math.random() * (a - b) + b;
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const lerp = (a,b,u)=>a+(b-a)*u;

  function resize() {
    dpr = Math.min(2, window.devicePixelRatio || 1);
    W = Math.floor(innerWidth  * dpr * cfg.quality);
    H = Math.floor(innerHeight * dpr * cfg.quality);
    canvas.width = W; canvas.height = H;
    glow.width = W; glow.height = H;
  }
  window.addEventListener('resize', resize);

  function mix(a,b,u){ return { r: lerp(a.r,b.r,u), g: lerp(a.g,b.g,u), b: lerp(a.b,b.b,u) }; }

  // Background bokeh
  const bgBokeh = [];
  function initBg() {
    bgBokeh.length = 0;
    const n = Math.floor(120 * Math.sqrt((innerWidth*innerHeight)/(1280*720)));
    for (let i=0;i<n;i++){
      const z = rand(1.0, 0.2);
      bgBokeh.push({
        x: rand(innerWidth), y: rand(innerHeight),
        r: rand(160, 40) * z,
        a: rand(0.10, 0.02) * z,
        hue: rand(1),
        drift: rand(0.25, 0.05) * z,
        phase: rand(Math.PI*2)
      });
    }
  }

  // Tree lights
  const lights = [];
  function initTree() {
    lights.length = 0;

    const baseY = 0.83;
    const topY  = 0.20;
    const cx    = 0.5;
    const height = baseY - topY;

    const layers = 10;
    for (let L=0; L<layers; L++){
      const u = L/(layers-1);
      const y = topY + u * height;
      const half = lerp(0.04, 0.28, u);

      const count = Math.floor(90 + 150*u);
      for (let i=0; i<count; i++){
        const v = Math.random();
        const x = cx + (rand(1,-1) * half * (0.15 + 0.85*Math.pow(v, 0.55)));
        const yy = y + rand(height/layers*0.55, -height/layers*0.55);
        const depth = rand(1.0, 0.25);

        const accent = Math.random() < 0.06;
        const colour = accent
          ? mix({r:120,g:220,b:255}, {r:255,g:120,b:180}, rand(1))
          : mix(cfg.gold, cfg.amber, rand(0.6,0.0)); // fixed

        lights.push({
          x, y: yy,
          r: rand(0.0038, 0.0018) * depth,
          a: rand(0.95, 0.35) * depth,
          tw: rand(1.0, 0.35) * (accent ? 1.2 : 1.0),
          w: rand(1.0, 0.2),
          flicker: rand(5.5, 1.5),
          phase: rand(Math.PI*2),
          depth,
          colour
        });
      }
    }

    // Garlands
    const garlands = 2;
    for (let g=0; g<garlands; g++){
      const turns = 4.2 + g*0.6;
      for (let i=0; i<220; i++){
        const u = i/219;
        const y = topY + u * height;
        const half = lerp(0.02, 0.27, u);
        const ang = u * Math.PI * 2 * turns + g*1.7;
        const x = cx + Math.cos(ang) * half * 0.85;

        lights.push({
          x, y,
          r: rand(0.0032, 0.0014) * rand(1.0,0.5),
          a: rand(0.55, 0.18),
          tw: rand(0.75, 0.25),
          w: rand(1.0, 0.2),
          flicker: rand(4.5, 1.0),
          phase: rand(Math.PI*2),
          depth: rand(1.0,0.4),
          colour: mix(cfg.warm, cfg.gold, rand(1))
        });
      }
    }

    // Star
    lights.push({
      x: cx, y: topY - 0.03,
      r: 0.010,
      a: 1.0,
      tw: 1.35,
      w: 1.0,
      flicker: 2.2,
      phase: rand(Math.PI*2),
      depth: 1.0,
      colour: {r:255,g:245,b:210},
      star: true
    });
  }


  function drawRadial(x, y, r, col, a, soft=1.0) {
    const px = x*W, py = y*H;
    const rr = r*Math.min(W,H);
    const grad = gtx.createRadialGradient(px, py, 0, px, py, rr);
    grad.addColorStop(0.0, `rgba(${col.r|0},${col.g|0},${col.b|0},${a})`);
    grad.addColorStop(0.3, `rgba(${col.r|0},${col.g|0},${col.b|0},${a*0.55})`);
    grad.addColorStop(1.0, `rgba(${col.r|0},${col.g|0},${col.b|0},0)`);
    gtx.fillStyle = grad;
    gtx.beginPath();
    gtx.arc(px, py, rr*soft, 0, Math.PI*2);
    gtx.fill();
  }

  function vignette() {
    const grd = ctx.createRadialGradient(W*0.5, H*0.55, Math.min(W,H)*0.10, W*0.5, H*0.55, Math.max(W,H)*0.75);
    grd.addColorStop(0, '#0a0712');
    grd.addColorStop(0.6, '#06050a');
    grd.addColorStop(1, '#020106');
    ctx.fillStyle = grd;
    ctx.fillRect(0,0,W,H);

    ctx.globalAlpha = 0.55;
    const wash = ctx.createLinearGradient(0,0,W,H);
    wash.addColorStop(0.0, 'rgba(40,25,70,0.55)');
    wash.addColorStop(0.5, 'rgba(10,8,18,0.25)');
    wash.addColorStop(1.0, 'rgba(90,40,10,0.35)');
    ctx.fillStyle = wash;
    ctx.fillRect(0,0,W,H);
    ctx.globalAlpha = 1;
  }

  function drawBackgroundBokeh(time) {
    ctx.save();
    ctx.globalCompositeOperation = 'screen';
    for (const b of bgBokeh) {
      const u = 0.5 + 0.5*Math.sin(time*0.0005*b.drift + b.phase);
      const a = b.a * (0.75 + 0.55*u);
      const col = mix({r:90,g:70,b:160}, {r:255,g:190,b:90}, b.hue);
      const x = (b.x + Math.sin(time*0.0002 + b.phase)*20) / innerWidth;
      const y = (b.y + Math.cos(time*0.00017 + b.phase)*16) / innerHeight;
      const r = (b.r / Math.min(innerWidth, innerHeight));

      const px = x*W, py = y*H;
      const rr = r*Math.min(W,H);
      const grad = ctx.createRadialGradient(px, py, 0, px, py, rr);
      grad.addColorStop(0, `rgba(${col.r|0},${col.g|0},${col.b|0},${a})`);
      grad.addColorStop(1, `rgba(${col.r|0},${col.g|0},${col.b|0},0)`);
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(px, py, rr, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  }

  function drawTree(time) {
    gtx.clearRect(0,0,W,H);

    const baseY = 0.84, topY = 0.19, cx = 0.5;
    for (let i=0;i<8;i++){
      const u = i/7;
      const y = lerp(topY, baseY, u);
      const half = lerp(0.03, 0.30, u);
      drawRadial(cx, y, half*0.65, {r:40,g:85,b:60}, 0.10, 1.6);
    }

    const sparkle = cfg.sparkle;
    for (const L of lights) {
      const flick = 0.65 + 0.45*Math.sin(time*0.001*L.flicker + L.phase);
      const pulse = (L.star ? 1.0 : 0.85) + 0.25*Math.sin(time*0.0016 + L.phase*1.7);
      const a = clamp(L.a * (0.55 + 0.55*flick) * sparkle, 0, 1.2);
      const r = L.r * (0.75 + 0.9*pulse) * (L.star ? 2.2 : 1.0);

      drawRadial(L.x, L.y, r*0.55, L.colour, a*0.9, 1.0);
      drawRadial(L.x, L.y, r*1.8, L.colour, a*0.55, 1.25);
      drawRadial(L.x, L.y, r*3.8, L.colour, a*0.18, 1.6);

      if (L.star) {
        const px = L.x*W, py = L.y*H;
        gtx.save();
        gtx.globalCompositeOperation = 'screen';
        gtx.translate(px, py);
        gtx.rotate(time*0.00025);
        gtx.globalAlpha = 0.35 * sparkle;
        for (let k=0;k<8;k++){
          gtx.rotate(Math.PI/4);
          gtx.fillStyle = 'rgba(255,245,210,0.55)';
          gtx.fillRect(0, -H*0.0012, Math.min(W,H)*0.08, H*0.0024);
        }
        gtx.restore();
      }
    }

    ctx.save();
    ctx.globalCompositeOperation = 'screen';
    ctx.filter = `blur(${Math.max(6, 10*dpr)}px)`;
    ctx.drawImage(glow, 0, 0);
    ctx.filter = `blur(${Math.max(2, 4*dpr)}px)`;
    ctx.globalAlpha = 0.85;
    ctx.drawImage(glow, 0, 0);
    ctx.filter = 'none';
    ctx.globalAlpha = 1;
    ctx.restore();
  }

  // Draw New Year mode (fireworks / 2026)
  function drawNewYear(time, dt) {
    gtx.clearRect(0,0,W,H);
    const elapsed = time - modeStartTime;
    const sparkle = cfg.sparkle;

    // Update and draw particles based on mode
    if (currentMode === MODE.MORPH_TO_FIREWORKS) {
      // Particles explode outward
      const progress = Math.min(elapsed / 2000, 1); // 2 seconds
      lights.forEach(L => {
        L.x += L.vx * dt * 0.001 * (1 - progress * 0.7);
        L.y += L.vy * dt * 0.001 * (1 - progress * 0.7);
        L.vy += 0.0003 * dt; // gravity
      });
      nyStars.forEach(s => {
        s.x += s.vx * dt * 0.001;
        s.y += s.vy * dt * 0.001;
        s.vy += 0.0002 * dt;
      });
      if (progress >= 1) transitionToMode(MODE.MORPH_TO_2026);
    }

    if (currentMode === MODE.FIREWORKS) {
      // Fireworks burst then reform
      const progress = Math.min(elapsed / 2500, 1);
      lights.forEach(L => {
        L.x += L.vx * dt * 0.001 * (1 - progress);
        L.y += L.vy * dt * 0.001 * (1 - progress);
        L.vy += 0.0002 * dt * (1 - progress);
      });
      nyStars.forEach(s => {
        s.x += s.vx * dt * 0.001 * (1 - progress);
        s.y += s.vy * dt * 0.001 * (1 - progress);
      });
      if (progress >= 1) transitionToMode(MODE.MORPH_TO_2026);
    }

    if (currentMode === MODE.MORPH_TO_2026) {
      // Particles lerp toward "2026" positions
      const progress = Math.min(elapsed / 2500, 1); // 2.5 seconds
      const ease = 1 - Math.pow(1 - progress, 3); // ease out cubic
      lights.forEach(L => {
        if (L.tx !== undefined) {
          L.x = lerp(L.x, L.tx, ease * 0.08);
          L.y = lerp(L.y, L.ty, ease * 0.08);
        }
      });
      nyStars.forEach(s => {
        s.x = lerp(s.x, s.tx, ease * 0.06);
        s.y = lerp(s.y, s.ty, ease * 0.06);
      });
      if (progress >= 1) transitionToMode(MODE.NEW_YEAR);
    }

    if (currentMode === MODE.NEW_YEAR) {
      // Gentle floating in "2026" formation
      lights.forEach(L => {
        if (L.tx !== undefined) {
          L.x = lerp(L.x, L.tx + Math.sin(time * 0.001 + L.phase) * 0.003, 0.02);
          L.y = lerp(L.y, L.ty + Math.cos(time * 0.0012 + L.phase) * 0.002, 0.02);
        }
      });
      nyStars.forEach((s, i) => {
        s.x = lerp(s.x, s.tx + Math.sin(time * 0.0008 + i) * 0.005, 0.02);
        s.y = lerp(s.y, s.ty + Math.cos(time * 0.001 + i) * 0.004, 0.02);
      });
    }

    // Draw all particles (same style as tree)
    for (const L of lights) {
      if (L.star && currentMode !== MODE.TREE) continue; // Hide original star
      const flick = 0.65 + 0.45*Math.sin(time*0.001*L.flicker + L.phase);
      const pulse = 0.85 + 0.25*Math.sin(time*0.0016 + L.phase*1.7);
      const a = clamp(L.a * (0.55 + 0.55*flick) * sparkle, 0, 1.2);
      const r = L.r * (0.75 + 0.9*pulse);

      drawRadial(L.x, L.y, r*0.55, L.colour, a*0.9, 1.0);
      drawRadial(L.x, L.y, r*1.8, L.colour, a*0.55, 1.25);
      drawRadial(L.x, L.y, r*3.8, L.colour, a*0.18, 1.6);
    }

    // Draw 26 mini stars
    for (const s of nyStars) {
      const pulse = 0.8 + 0.3*Math.sin(time*0.002 + s.phase);
      drawRadial(s.x, s.y, s.r*0.6, s.colour, 0.9*pulse, 1.0);
      drawRadial(s.x, s.y, s.r*2, s.colour, 0.5*pulse, 1.3);

      // Mini star rays
      const px = s.x*W, py = s.y*H;
      gtx.save();
      gtx.globalCompositeOperation = 'screen';
      gtx.translate(px, py);
      gtx.rotate(time*0.0004 + s.phase);
      gtx.globalAlpha = 0.25 * sparkle * pulse;
      for (let k=0;k<4;k++){
        gtx.rotate(Math.PI/2);
        gtx.fillStyle = 'rgba(255,245,210,0.5)';
        gtx.fillRect(0, -H*0.0008, Math.min(W,H)*0.025, H*0.0016);
      }
      gtx.restore();
    }

    // Bloom/glow pass
    ctx.save();
    ctx.globalCompositeOperation = 'screen';
    ctx.filter = `blur(${Math.max(6, 10*dpr)}px)`;
    ctx.drawImage(glow, 0, 0);
    ctx.filter = `blur(${Math.max(2, 4*dpr)}px)`;
    ctx.globalAlpha = 0.85;
    ctx.drawImage(glow, 0, 0);
    ctx.filter = 'none';
    ctx.globalAlpha = 1;
    ctx.restore();
  }

  function filmGrain() {
    const w = Math.min(320, W), h = Math.min(180, H);
    const img = ctx.getImageData(0,0,w,h);
    const d = img.data;
    const strength = 10;
    for (let i=0;i<d.length;i+=4){
      const g = (Math.random()*2-1) * strength;
      d[i]   = clamp(d[i]   + g, 0, 255);
      d[i+1] = clamp(d[i+1] + g, 0, 255);
      d[i+2] = clamp(d[i+2] + g, 0, 255);
    }
    const tmp = document.createElement('canvas');
    tmp.width = w; tmp.height = h;
    tmp.getContext('2d').putImageData(img,0,0);

    ctx.save();
    ctx.globalAlpha = 0.08;
    ctx.imageSmoothingEnabled = true;
    ctx.drawImage(tmp, 0, 0, W, H);
    ctx.restore();
  }

  let lastTime = performance.now();

  function tick(now) {
    const time = now - t0;
    const dt = now - lastTime;
    lastTime = now;

    vignette();
    drawBackgroundBokeh(now);

    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.filter = `blur(${Math.max(8, 14*dpr)}px)`;
    ctx.drawImage(canvas, 0, 0);
    ctx.filter = 'none';
    ctx.globalAlpha = 1;
    ctx.restore();

    // Draw based on current mode
    if (currentMode === MODE.TREE) {
      drawTree(now);
    } else {
      drawNewYear(time, dt);
    }

    filmGrain();

    requestAnimationFrame(tick);
  }

  // Secret trigger: Press 'N' key to toggle New Year mode (for testing)
  document.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() === 'n' && !e.ctrlKey && !e.metaKey) {
      if (currentMode === MODE.TREE) {
        // Start the morph sequence
        transitionToMode(MODE.MORPH_TO_FIREWORKS);
      } else if (currentMode === MODE.NEW_YEAR) {
        // Trigger another fireworks burst
        transitionToMode(MODE.FIREWORKS);
      }
    }
  });

  // Sidebar toggle
  const sidebar = document.getElementById('sidebar');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const musicbarEl = document.getElementById('musicbar');

  function toggleSidebar() {
    sidebar.classList.toggle('expanded');
    // Sync musicbar position with sidebar state
    musicbarEl.classList.toggle('sidebar-open', sidebar.classList.contains('expanded'));
  }

  sidebarToggle.addEventListener('click', toggleSidebar);

  // Clicking icons toggles the control (works in both collapsed and expanded modes)
  document.querySelectorAll('.control-icon').forEach(icon => {
    icon.addEventListener('click', (e) => {
      const controlGroup = icon.closest('.control-group');
      const btn = controlGroup?.querySelector('.control-btn');
      if (btn) {
        btn.click();
      }
    });
  });

  // Snow toggle
  const toggleSnowBtn = document.getElementById('toggleSnow');
  toggleSnowBtn.addEventListener('click', () => {
    const snow = document.getElementById('snow');
    const isVisible = snow.style.display !== 'none';
    snow.style.display = isVisible ? 'none' : 'block';
    toggleSnowBtn.textContent = isVisible ? 'Snow Off' : 'Snow On';
    toggleSnowBtn.classList.toggle('active', !isVisible);
  });

  // Image overlay cycling through images
  const toggleImageBtn = document.getElementById('toggleImage');
  const imageOverlay = document.getElementById('imageOverlay');
  const overlayImg = imageOverlay.querySelector('img');
  const imageList = [
    null, // Off state
    'img/Merry Xmas.png',
    'img/Happy NY.png'
  ];
  let currentImageIndex = 1; // Start with first image visible

  function updateImageOverlay() {
    if (imageList[currentImageIndex] === null) {
      imageOverlay.classList.remove('visible', 'happy-ny');
      toggleImageBtn.textContent = 'Image Off';
      toggleImageBtn.classList.remove('active');
    } else {
      overlayImg.src = imageList[currentImageIndex];
      imageOverlay.classList.add('visible');
      // Apply special class for Happy NY image (index 2)
      imageOverlay.classList.toggle('happy-ny', currentImageIndex === 2);
      // Show short name
      const fileName = imageList[currentImageIndex].split('/').pop().replace('.png', '');
      toggleImageBtn.textContent = fileName.length > 12 ? fileName.slice(0, 12) + '...' : fileName;
      toggleImageBtn.classList.add('active');
    }
  }

  toggleImageBtn.addEventListener('click', () => {
    currentImageIndex = (currentImageIndex + 1) % imageList.length;
    updateImageOverlay();
  });

  // Set initial button text
  updateImageOverlay();

  // Fullscreen toggle
  const toggleFullscreenBtn = document.getElementById('toggleFullscreen');
  const fullscreenCorner = document.getElementById('fullscreenCorner');

  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen?.();
      toggleFullscreenBtn.classList.add('active');
    } else {
      document.exitFullscreen?.();
      toggleFullscreenBtn.classList.remove('active');
    }
  }

  toggleFullscreenBtn.addEventListener('click', toggleFullscreen);
  fullscreenCorner.addEventListener('click', toggleFullscreen);

  // Sparkle control
  const sparkleCtrl = document.getElementById('sparkleCtrl');
  const sparkleVal = document.getElementById('sparkleVal');
  sparkleCtrl.addEventListener('input', () => {
    cfg.sparkle = parseFloat(sparkleCtrl.value);
    sparkleVal.textContent = cfg.sparkle.toFixed(1);
  });

  // Font size cycling
  const fontSizes = [
    { scale: 1.0, label: '100%' },
    { scale: 1.25, label: '125%' },
    { scale: 1.5, label: '150%' },
    { scale: 2.0, label: '200%' }
  ];
  let fontSizeIndex = 0;
  const fontSizeIndicator = document.getElementById('fontSizeIndicator');
  const fontSizeBtn = document.getElementById('fontSizeBtn');
  const fromContainer = document.querySelector('.from-container');
  let fontSizeTimeout;

  function cycleFontSize() {
    fontSizeIndex = (fontSizeIndex + 1) % fontSizes.length;
    const { scale, label } = fontSizes[fontSizeIndex];
    fromContainer.style.transform = `translateX(-50%) scale(${scale})`;
    fromContainer.style.transformOrigin = 'center bottom';

    // Update button text
    fontSizeBtn.textContent = 'Text Size: ' + label;

    // Show indicator
    fontSizeIndicator.textContent = label;
    fontSizeIndicator.classList.remove('hiding');
    fontSizeIndicator.classList.add('visible');

    clearTimeout(fontSizeTimeout);
    fontSizeTimeout = setTimeout(() => {
      fontSizeIndicator.classList.add('hiding');
      setTimeout(() => {
        fontSizeIndicator.classList.remove('visible', 'hiding');
      }, 300);
    }, 1200);
  }

  // Font size button click
  fontSizeBtn.addEventListener('click', cycleFontSize);

  // Font texture toggle
  const fontTextureBtn = document.getElementById('fontTextureBtn');
  const fromWrapper = document.querySelector('.from-wrapper');
  const textures = [
    { class: '', label: 'Regular' },
    { class: 'metallic-gold', label: 'Platinum' },
    { class: 'bimetallic', label: 'Chrome' },
    { class: 'gold-stripes', label: 'Titanium' },
    { class: 'chrome', label: 'Champagne' },
    { class: 'liquid-gold', label: '24K Gold' }
  ];
  let textureIndex = 0;

  function cycleTexture() {
    // Remove current texture class
    fromWrapper.classList.remove('metallic-gold', 'gold-stripes', 'bimetallic', 'chrome', 'liquid-gold');

    textureIndex = (textureIndex + 1) % textures.length;
    const { class: cls, label } = textures[textureIndex];

    if (cls) {
      fromWrapper.classList.add(cls);
    }

    fontTextureBtn.textContent = 'Texture: ' + label;
  }

  fontTextureBtn.addEventListener('click', cycleTexture);

  // Random settings button
  const randomBtn = document.getElementById('randomBtn');

  function randomizeSetting() {
    // List of random actions (image, text size, snow, tree sparkle only - no music, no text content)
    const actions = [
      // Change snow density
      () => {
        const val = Math.floor(Math.random() * 181) + 20; // 20-200
        document.getElementById('snowDensity').value = val;
        document.getElementById('densityVal').textContent = val;
        createSnowflakes();
      },
      // Change snow speed
      () => {
        const val = (Math.random() * 13 + 2).toFixed(1); // 2-15
        document.getElementById('snowSpeed').value = val;
        document.getElementById('speedVal').textContent = val + 's';
        createSnowflakes();
      },
      // Change tree sparkle
      () => {
        const val = (Math.random() * 2.8 + 0.2).toFixed(1); // 0.2-3.0
        cfg.sparkle = parseFloat(val);
        sparkleCtrl.value = val;
        sparkleVal.textContent = val;
      },
      // Toggle snow
      () => {
        const snow = document.getElementById('snow');
        const isVisible = snow.style.display !== 'none';
        snow.style.display = isVisible ? 'none' : 'block';
        toggleSnowBtn.textContent = isVisible ? 'Snow Off' : 'Snow On';
        toggleSnowBtn.classList.toggle('active', !isVisible);
      },
      // Cycle image overlay
      () => {
        currentImageIndex = (currentImageIndex + 1) % imageList.length;
        updateImageOverlay();
      },
      // Cycle font size (not content)
      () => {
        cycleFontSize();
      }
    ];

    // Pick a random action and execute it
    const action = actions[Math.floor(Math.random() * actions.length)];
    action();
  }

  randomBtn.addEventListener('click', () => {
    // Add shake animation
    randomBtn.classList.remove('shake');
    void randomBtn.offsetWidth; // Force reflow
    randomBtn.classList.add('shake');

    // Randomize a setting
    randomizeSetting();
  });

  // Hotkey overlay
  const hotkeyOverlay = document.getElementById('hotkeyOverlay');
  let hotkeyVisible = false;

  function showHotkeyHelp() {
    hotkeyOverlay.classList.add('visible');
    hotkeyVisible = true;
  }

  function hideHotkeyHelp() {
    hotkeyOverlay.classList.remove('visible');
    hotkeyVisible = false;
  }

  window.addEventListener('keydown', (e) => {
    // Skip if typing in an input
    if (e.target.tagName === 'INPUT' || e.target.isContentEditable) return;

    const k = e.key.toLowerCase();

    // If hotkey overlay is visible, any key dismisses it
    if (hotkeyVisible && k !== '?') {
      hideHotkeyHelp();
      return;
    }

    // Escape: close modals or exit fullscreen
    if (e.key === 'Escape') {
      if (hotkeyVisible) { hideHotkeyHelp(); return; }
      if (musicModal.classList.contains('visible')) { musicModal.classList.remove('visible'); return; }
      if (document.fullscreenElement) { document.exitFullscreen?.(); return; }
      return;
    }

    // ? or / : Show hotkey help
    if (k === '?' || (e.shiftKey && k === '/')) {
      showHotkeyHelp();
      return;
    }

    // F: Toggle fullscreen
    if (k === 'f') {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen?.();
      else document.exitFullscreen?.();
    }

    // S: Toggle snow
    if (k === 's') {
      const snow = document.getElementById('snow');
      const isVisible = snow.style.display !== 'none';
      snow.style.display = isVisible ? 'none' : 'block';
      toggleSnowBtn.textContent = isVisible ? 'Snow Off' : 'Snow On';
      toggleSnowBtn.classList.toggle('active', !isVisible);
    }

    // C: Toggle controls sidebar
    if (k === 'c') toggleSidebar();

    // T: Cycle font size
    if (k === 't') cycleFontSize();

    // +/=: Increase sparkle
    if (k === '+' || k === '=') {
      cfg.sparkle = clamp(cfg.sparkle + 0.15, 0.2, 3.0);
      sparkleCtrl.value = cfg.sparkle;
      sparkleVal.textContent = cfg.sparkle.toFixed(1);
    }

    // -/_: Decrease sparkle
    if (k === '-' || k === '_') {
      cfg.sparkle = clamp(cfg.sparkle - 0.15, 0.2, 3.0);
      sparkleCtrl.value = cfg.sparkle;
      sparkleVal.textContent = cfg.sparkle.toFixed(1);
    }

    // I: Cycle image overlay
    if (k === 'i') {
      currentImageIndex = (currentImageIndex + 1) % imageList.length;
      updateImageOverlay();
    }

    // M: Toggle music (play/stop)
    if (k === 'm') {
      if (ytReady) {
        if (currentTrack >= 0) {
          stopAllTracks();
        } else {
          if (playerReady[0]) playTrack(0);
        }
      }
    }

    // 1-6: Play specific music track
    if (['1', '2', '3', '4', '5', '6'].includes(k)) {
      const trackIndex = parseInt(k) - 1;
      if (ytReady && musicTracks[trackIndex]) playTrack(trackIndex);
    }
  });

  // Snow controls
  function createSnowflakes() {
    const container = document.getElementById('snow');
    const density = parseInt(document.getElementById('snowDensity').value);
    const speed = parseFloat(document.getElementById('snowSpeed').value);

    container.innerHTML = '';

    // Layer config: [count%, speedMult, sizeRange, opacityRange, blur, spin]
    const layers = [
      { pct: 0.25, speedMult: 2.5, size: [6, 10],  opacity: [0.2, 0.35], blur: [2.5, 4], spin: false },  // Back - blurry, slow
      { pct: 0.35, speedMult: 1.5, size: [8, 14],  opacity: [0.35, 0.55], blur: [1, 2], spin: true },    // Mid
      { pct: 0.40, speedMult: 1.0, size: [12, 22], opacity: [0.6, 0.9], blur: [0, 0], spin: true }       // Front - crisp, fast
    ];

    layers.forEach(layer => {
      const count = Math.floor(density * layer.pct);

      for (let i = 0; i < count; i++) {
        const flake = document.createElement('div');
        flake.className = 'snowflake';

        const inner = document.createElement('span');
        inner.textContent = '';

        const left = Math.random() * 120 - 10;
        const size = layer.size[0] + Math.random() * (layer.size[1] - layer.size[0]);
        const opacity = layer.opacity[0] + Math.random() * (layer.opacity[1] - layer.opacity[0]);
        const blur = layer.blur[0] + Math.random() * (layer.blur[1] - layer.blur[0]);
        const fallDuration = (speed * layer.speedMult) + Math.random() * speed * layer.speedMult;
        const spinDuration = 2 + Math.random() * 6;
        const delay = Math.random() * -fallDuration;

        flake.style.cssText = `
          left: ${left}vw;
          font-size: ${size}px;
          opacity: ${opacity};
          animation-duration: ${fallDuration}s;
          animation-delay: ${delay}s;
          filter: blur(${blur}px);
        `;

        if (layer.spin) {
          inner.style.animationDuration = spinDuration + 's';
          inner.style.animationDelay = (Math.random() * -spinDuration) + 's';
        } else {
          inner.style.animation = 'none';
        }

        flake.appendChild(inner);
        container.appendChild(flake);
      }
    });
  }

  function updateSnow() {
    const density = parseInt(document.getElementById('snowDensity').value);
    const speed = parseFloat(document.getElementById('snowSpeed').value);

    document.getElementById('densityVal').textContent = density;
    document.getElementById('speedVal').textContent = speed + 's';

    createSnowflakes();
  }

  document.getElementById('snowDensity').addEventListener('input', updateSnow);
  document.getElementById('snowSpeed').addEventListener('input', updateSnow);

  // Handle contenteditable "From" input and prefix
  const fromInput = document.getElementById('fromInput');
  const fromPrefix = document.getElementById('fromPrefix');

  // Load saved values from localStorage
  const savedPrefix = localStorage.getItem('xmasCard_fromPrefix');
  const savedName = localStorage.getItem('xmasCard_fromName');
  if (savedPrefix !== null) fromPrefix.textContent = savedPrefix;
  if (savedName !== null) fromInput.textContent = savedName;

  // Save to localStorage on change
  function saveFromFields() {
    localStorage.setItem('xmasCard_fromPrefix', fromPrefix.textContent);
    localStorage.setItem('xmasCard_fromName', fromInput.textContent);
  }

  // Prevent line breaks in editable fields and save on blur
  [fromInput, fromPrefix].forEach(el => {
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        el.blur();
      }
    });
    el.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text/plain');
      document.execCommand('insertText', false, text.replace(/\n/g, ' '));
    });
    el.addEventListener('blur', saveFromFields);
    el.addEventListener('input', saveFromFields);
  });

  // Restore signature button
  document.getElementById('restoreSignature').addEventListener('click', () => {
    fromPrefix.textContent = 'From:';
    fromInput.textContent = '';
    saveFromFields();
  });

  // Text visibility toggle with fade animation
  const toggleTextBtn = document.getElementById('toggleText');
  let textVisible = localStorage.getItem('xmasCard_textVisible') !== 'false';

  function updateTextVisibility(animate = false) {
    if (animate) {
      // Fade out first
      fromContainer.classList.add('fading');
      setTimeout(() => {
        // Update state
        fromContainer.style.opacity = textVisible ? '1' : '0';
        fromContainer.style.pointerEvents = textVisible ? 'auto' : 'none';
        fromContainer.classList.remove('fading');
      }, 400);
    } else {
      fromContainer.style.opacity = textVisible ? '1' : '0';
      fromContainer.style.pointerEvents = textVisible ? 'auto' : 'none';
    }
    toggleTextBtn.textContent = textVisible ? 'Text On' : 'Text Off';
    toggleTextBtn.classList.toggle('active', textVisible);
    localStorage.setItem('xmasCard_textVisible', textVisible);
  }

  updateTextVisibility(false); // No animation on initial load

  toggleTextBtn.addEventListener('click', () => {
    // Fade out, toggle, fade in
    fromContainer.classList.add('fading');
    setTimeout(() => {
      textVisible = !textVisible;
      updateTextVisibility(false);
      // Small delay then fade back in
      setTimeout(() => {
        fromContainer.classList.remove('fading');
      }, 50);
    }, 400);
  });

  // Initialize snowflakes
  createSnowflakes();

  resize();
  initBg();
  initTree();
  requestAnimationFrame(tick);

  // ========== MUSIC PLAYER ==========
  const defaultTracks = [
    'u-llX00huRE',  // Track 1
    'ns1gReXtNag',  // Track 2
    'XQvzdKy1YQQ',  // Track 3
    'nCIO60uatRY',  // Track 4
    '6SlwnNKsidw',  // Track 5
    'PZtrgRejwG0'   // Track 6
  ];

  const trackNames = [
    'Carol of the Bells',
    'Silent Night',
    'O Holy Night',
    'Jingle Bells',
    'Winter Wonderland',
    'Christmas Medley'
  ];

  let musicTracks = [...defaultTracks];
  let players = {};
  let playerReady = {};
  let currentTrack = -1;
  let ytReady = false;
  let isPlaying = false;

  // UI Elements
  const musicbar = document.getElementById('musicbar');
  const progressBar = document.getElementById('musicbarProgressBar');
  const progressContainer = document.getElementById('musicbarProgress');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const playIcon = document.getElementById('playIcon');
  const pauseIcon = document.getElementById('pauseIcon');
  const currentTimeEl = document.getElementById('currentTime');
  const totalTimeEl = document.getElementById('totalTime');
  const currentTrackName = document.getElementById('currentTrackName');
  const trackInfo = document.getElementById('trackInfo');
  const tracklistDropdown = document.getElementById('tracklistDropdown');

  // Format time as M:SS
  function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  // Update play/pause button icons
  function updatePlayPauseIcon() {
    if (isPlaying) {
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'block';
    } else {
      playIcon.style.display = 'block';
      pauseIcon.style.display = 'none';
    }
  }

  // Update track name display
  function updateTrackDisplay() {
    if (currentTrack >= 0) {
      currentTrackName.textContent = trackNames[currentTrack];
    } else {
      currentTrackName.textContent = 'Select a track';
    }
    // Update tracklist playing state
    document.querySelectorAll('.musicbar-tracklist-item').forEach((item, i) => {
      item.classList.toggle('playing', i === currentTrack && isPlaying);
    });
  }

  // Extract YouTube video ID from URL (supports music/shorts/live)
  function extractYouTubeId(url) {
    if (!url) return null;
    // Already an ID
    if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
    // Full URL patterns
    const patterns = [
      /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
      /youtube\.com\/.*[?&]v=([a-zA-Z0-9_-]{11})/,
      /youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/,
      /youtube\.com\/live\/([a-zA-Z0-9_-]{11})/
    ];
    for (const pattern of patterns) {
      const match = url.match(pattern);
      if (match) return match[1];
    }
    return null;
  }

  // Load YouTube IFrame API
  const ytScript = document.createElement('script');
  ytScript.src = 'https://www.youtube.com/iframe_api';
  document.head.appendChild(ytScript);

  window.onYouTubeIframeAPIReady = function() {
    ytReady = true;
    createPlayers();
  };

  function createPlayers() {
    const container = document.getElementById('ytPlayers');
    container.innerHTML = '';
    players = {};
    playerReady = {};

    // Set origin to current domain for postMessage security
    const origin = window.location.origin;

    musicTracks.forEach((videoId, i) => {
      if (!videoId) return;
      const div = document.createElement('div');
      div.id = 'ytPlayer' + i;
      container.appendChild(div);

      players[i] = new YT.Player('ytPlayer' + i, {
        height: '100',
        width: '100',
        videoId: videoId,
        playerVars: {
          autoplay: 0,
          controls: 0,
          disablekb: 1,
          enablejsapi: 1,
          fs: 0,
          loop: 1,
          modestbranding: 1,
          playlist: videoId,
          playsinline: 1,
          origin: origin
        },
        events: {
          onReady: (event) => {
            playerReady[i] = true;
            event.target.setVolume(70);
          },
          onStateChange: (e) => {
            if (e.data === YT.PlayerState.PLAYING) {
              // Stop all OTHER tracks when this one starts playing
              Object.keys(players).forEach(key => {
                const idx = parseInt(key);
                if (idx !== i && players[idx] && typeof players[idx].pauseVideo === 'function') {
                  try { players[idx].pauseVideo(); } catch(err) {}
                }
              });
              currentTrack = i;
              isPlaying = true;
              updatePlayPauseIcon();
              updateTrackDisplay();
            } else if (e.data === YT.PlayerState.ENDED) {
              // Play next track in loop (all 5 songs cycle)
              const nextTrackIdx = (i + 1) % musicTracks.length;
              if (musicTracks[nextTrackIdx] && playerReady[nextTrackIdx]) {
                playTrack(nextTrackIdx);
              }
            } else if (e.data === YT.PlayerState.PAUSED) {
              if (currentTrack === i) {
                isPlaying = false;
                updatePlayPauseIcon();
                updateTrackDisplay();
              }
            }
          },
          onError: (e) => {
            console.log('YouTube Player Error:', e.data);
          }
        }
      });
    });
  }

  function stopAllTracks(clearSaved = false) {
    Object.keys(players).forEach(key => {
      const i = parseInt(key);
      if (players[i] && typeof players[i].pauseVideo === 'function') {
        try {
          players[i].pauseVideo();
          players[i].seekTo(0);
        } catch(e) {}
      }
    });
    currentTrack = -1;
    isPlaying = false;
    progressBar.style.width = '0%';
    currentTimeEl.textContent = '0:00';
    totalTimeEl.textContent = '0:00';
    updatePlayPauseIcon();
    updateTrackDisplay();

    // Clear saved position if explicitly stopped
    if (clearSaved) {
      localStorage.removeItem('xmasCard_currentTrack');
      localStorage.removeItem('xmasCard_trackTime');
    }
  }

  function playTrack(index) {
    // Stop all tracks first
    stopAllTracks();

    // Play selected track
    if (players[index] && playerReady[index]) {
      try {
        players[index].seekTo(0);
        players[index].playVideo();
        currentTrack = index;
        isPlaying = true;
        updatePlayPauseIcon();
        updateTrackDisplay();
        // Close tracklist dropdown
        musicbar.classList.remove('tracklist-open');
      } catch(e) {
        console.log('Error playing track:', e);
      }
    } else {
      console.log('Player not ready yet for track', index);
    }
  }

  function pauseTrack() {
    if (currentTrack >= 0 && players[currentTrack]) {
      try {
        players[currentTrack].pauseVideo();
        isPlaying = false;
        updatePlayPauseIcon();
        updateTrackDisplay();
      } catch(e) {}
    }
  }

  function resumeTrack() {
    if (currentTrack >= 0 && players[currentTrack]) {
      try {
        players[currentTrack].playVideo();
        isPlaying = true;
        updatePlayPauseIcon();
        updateTrackDisplay();
      } catch(e) {}
    }
  }

  // Update progress bar and time display + save to localStorage
  setInterval(() => {
    if (currentTrack >= 0 && players[currentTrack] && playerReady[currentTrack]) {
      try {
        const player = players[currentTrack];
        const duration = player.getDuration();
        const time = player.getCurrentTime();
        if (duration > 0) {
          const percent = (time / duration) * 100;
          progressBar.style.width = percent + '%';
          currentTimeEl.textContent = formatTime(time);
          totalTimeEl.textContent = formatTime(duration);

          // Save current track and time to localStorage
          if (isPlaying) {
            localStorage.setItem('xmasCard_currentTrack', currentTrack);
            localStorage.setItem('xmasCard_trackTime', time);
          }
        }
      } catch(e) {}
    }
  }, 250);

  // Restore track position from localStorage on page load
  function restoreTrackPosition() {
    const savedTrack = localStorage.getItem('xmasCard_currentTrack');
    const savedTime = localStorage.getItem('xmasCard_trackTime');

    if (savedTrack !== null && savedTime !== null) {
      const trackIdx = parseInt(savedTrack);
      const time = parseFloat(savedTime);

      if (trackIdx >= 0 && trackIdx < musicTracks.length && playerReady[trackIdx]) {
        currentTrack = trackIdx;
        updateTrackDisplay();

        // Seek to saved position and start playing
        players[trackIdx].seekTo(time, true);
        players[trackIdx].playVideo();
      }
    }
  }

  // Wait for first player to be ready, then restore position
  const checkPlayersReady = setInterval(() => {
    const savedTrack = localStorage.getItem('xmasCard_currentTrack');
    if (savedTrack !== null) {
      const trackIdx = parseInt(savedTrack);
      if (playerReady[trackIdx]) {
        clearInterval(checkPlayersReady);
        restoreTrackPosition();
      }
    } else {
      clearInterval(checkPlayersReady);
    }
  }, 500);

  // Progress bar click to seek
  progressContainer.addEventListener('click', (e) => {
    if (currentTrack >= 0 && players[currentTrack] && playerReady[currentTrack]) {
      const rect = progressContainer.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const percent = clickX / rect.width;
      const duration = players[currentTrack].getDuration();
      if (duration > 0) {
        players[currentTrack].seekTo(percent * duration, true);
      }
    }
  });

  // Play/Pause button
  playPauseBtn.addEventListener('click', () => {
    if (!ytReady) return;
    if (currentTrack < 0) {
      // No track selected, play first track
      if (playerReady[0]) playTrack(0);
    } else if (isPlaying) {
      pauseTrack();
    } else {
      resumeTrack();
    }
  });

  // Previous track
  document.getElementById('prevTrack').addEventListener('click', () => {
    if (!ytReady) return;
    const prevIdx = currentTrack <= 0 ? musicTracks.length - 1 : currentTrack - 1;
    if (playerReady[prevIdx]) playTrack(prevIdx);
  });

  // Next track
  document.getElementById('nextTrack').addEventListener('click', () => {
    if (!ytReady) return;
    const nextIdx = (currentTrack + 1) % musicTracks.length;
    if (playerReady[nextIdx]) playTrack(nextIdx);
  });

  // Track info click toggles tracklist dropdown
  trackInfo.addEventListener('click', () => {
    musicbar.classList.toggle('tracklist-open');
  });

  // Tracklist item click to play
  document.querySelectorAll('.musicbar-tracklist-item').forEach(item => {
    item.addEventListener('click', () => {
      const track = parseInt(item.dataset.track);
      if (!ytReady) return;
      if (!playerReady[track]) return;
      playTrack(track);
    });
  });

  // Close tracklist when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.musicbar-center') && !e.target.closest('.musicbar-tracklist')) {
      musicbar.classList.remove('tracklist-open');
    }
  });

  // Music modal
  const musicModal = document.getElementById('musicModal');

  document.getElementById('editMusicUrls').addEventListener('click', () => {
    // Populate inputs with current URLs
    musicTracks.forEach((id, i) => {
      document.getElementById('musicUrl' + i).value = id ? 'https://youtube.com/watch?v=' + id : '';
    });
    musicModal.classList.add('visible');
  });

  document.getElementById('closeMusicModal').addEventListener('click', () => {
    musicModal.classList.remove('visible');
  });

  document.getElementById('saveMusicUrls').addEventListener('click', () => {
    const newTracks = [];
    for (let i = 0; i < 6; i++) {
      const url = document.getElementById('musicUrl' + i).value.trim();
      newTracks[i] = extractYouTubeId(url) || defaultTracks[i] || '';
    }
    musicTracks = newTracks;

    // Stop current playback
    currentTrack = -1;
    document.querySelectorAll('.music-btn').forEach(btn => btn.classList.remove('playing'));

    // Recreate players
    if (ytReady) {
      createPlayers();
    }

    musicModal.classList.remove('visible');
  });

  // Close modal on outside click
  musicModal.addEventListener('click', (e) => {
    if (e.target === musicModal) {
      musicModal.classList.remove('visible');
    }
  });

  // Views counter
  fetch('https://api.counterapi.dev/v1/xmas-tree-card/visits/up')
    .then(res => res.json())
    .then(data => {
      document.getElementById('viewCount').textContent = data.count.toLocaleString();
    })
    .catch(() => {
      document.querySelector('.views-counter').style.display = 'none';
    });

  // Visitor country leaderboard with Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyD7HytY4z9gPu3fpvQTJgahYxOvOc3l8-w",
    authDomain: "merryxmas-712c1.firebaseapp.com",
    databaseURL: "https://merryxmas-712c1-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "merryxmas-712c1",
    storageBucket: "merryxmas-712c1.firebasestorage.app",
    messagingSenderId: "351515997430",
    appId: "1:351515997430:web:234e9633ba8cff887828d7"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Country code to flag emoji
  function countryToFlag(countryCode) {
    if (!countryCode || countryCode.length !== 2) return '';
    const codePoints = countryCode
      .toUpperCase()
      .split('')
      .map(char => 127397 + char.charCodeAt(0));
    return String.fromCodePoint(...codePoints);
  }

  // Country code to name
  const countryNames = {
    AF:'Afghanistan',AL:'Albania',DZ:'Algeria',AD:'Andorra',AO:'Angola',AR:'Argentina',
    AM:'Armenia',AU:'Australia',AT:'Austria',AZ:'Azerbaijan',BS:'Bahamas',BH:'Bahrain',
    BD:'Bangladesh',BB:'Barbados',BY:'Belarus',BE:'Belgium',BZ:'Belize',BJ:'Benin',
    BT:'Bhutan',BO:'Bolivia',BA:'Bosnia',BW:'Botswana',BR:'Brazil',BN:'Brunei',
    BG:'Bulgaria',KH:'Cambodia',CM:'Cameroon',CA:'Canada',CL:'Chile',CN:'China',
    CO:'Colombia',CR:'Costa Rica',HR:'Croatia',CU:'Cuba',CY:'Cyprus',CZ:'Czechia',
    DK:'Denmark',DO:'Dominican Republic',EC:'Ecuador',EG:'Egypt',SV:'El Salvador',
    EE:'Estonia',ET:'Ethiopia',FI:'Finland',FR:'France',GE:'Georgia',DE:'Germany',
    GH:'Ghana',GR:'Greece',GT:'Guatemala',HN:'Honduras',HK:'Hong Kong',HU:'Hungary',
    IS:'Iceland',IN:'India',ID:'Indonesia',IR:'Iran',IQ:'Iraq',IE:'Ireland',IL:'Israel',
    IT:'Italy',JM:'Jamaica',JP:'Japan',JO:'Jordan',KZ:'Kazakhstan',KE:'Kenya',KR:'South Korea',
    KW:'Kuwait',LV:'Latvia',LB:'Lebanon',LT:'Lithuania',LU:'Luxembourg',MY:'Malaysia',
    MX:'Mexico',MA:'Morocco',NL:'Netherlands',NZ:'New Zealand',NG:'Nigeria',NO:'Norway',
    PK:'Pakistan',PA:'Panama',PY:'Paraguay',PE:'Peru',PH:'Philippines',PL:'Poland',
    PT:'Portugal',PR:'Puerto Rico',QA:'Qatar',RO:'Romania',RU:'Russia',SA:'Saudi Arabia',
    RS:'Serbia',SG:'Singapore',SK:'Slovakia',SI:'Slovenia',ZA:'South Africa',ES:'Spain',
    LK:'Sri Lanka',SE:'Sweden',CH:'Switzerland',TW:'Taiwan',TH:'Thailand',TR:'Turkey',
    UA:'Ukraine',AE:'UAE',GB:'United Kingdom',US:'United States',UY:'Uruguay',VE:'Venezuela',
    VN:'Vietnam',ZW:'Zimbabwe'
  };
  function countryName(code) {
    return countryNames[code?.toUpperCase()] || code;
  }

  // Register visit and increment counter
  async function registerVisit() {
    try {
      const res = await fetch('https://ipapi.co/json/');
      const data = await res.json();
      const countryCode = data.country_code;

      if (countryCode) {
        // Increment visit count using transaction
        const countRef = db.ref('leaderboard/' + countryCode + '/count');
        countRef.transaction((currentCount) => {
          return (currentCount || 0) + 1;
        });
      }
    } catch (err) {
      console.log('Could not register visit');
    }
  }

  // Display leaderboard sorted by visits
  function displayLeaderboard() {
    const leaderboard = document.getElementById('visitorLeaderboard');

    db.ref('leaderboard').on('value', (snapshot) => {
      leaderboard.innerHTML = '';
      const countries = snapshot.val();

      if (countries) {
        // Convert to array and sort by count descending
        const sorted = Object.entries(countries)
          .map(([code, data]) => ({ code, count: data.count || 0 }))
          .sort((a, b) => b.count - a.count);

        sorted.forEach(({ code, count }, index) => {
          const entry = document.createElement('div');
          entry.className = 'leaderboard-entry';

          // Add medal classes for top 3
          if (index === 0) entry.classList.add('gold');
          else if (index === 1) entry.classList.add('silver');
          else if (index === 2) entry.classList.add('bronze');

          entry.style.animationDelay = `${index * 0.08}s`;

          const flag = document.createElement('span');
          flag.className = 'entry-flag';
          flag.textContent = countryToFlag(code);

          const countEl = document.createElement('span');
          countEl.className = 'entry-count';
          countEl.textContent = count.toLocaleString();

          entry.appendChild(flag);
          entry.appendChild(countEl);
          entry.dataset.tooltip = `${countryName(code)} (${count})`;

          // Flag cursor on hover
          const flagEmoji = countryToFlag(code);
          entry.addEventListener('mouseenter', () => {
            entry.style.cursor = `url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><text y="24" font-size="24">${flagEmoji}</text></svg>') 16 16, auto`;
          });
          entry.addEventListener('mouseleave', () => {
            entry.style.cursor = 'pointer';
          });

          leaderboard.appendChild(entry);
        });

        // Show container
        setTimeout(() => leaderboard.classList.add('visible'), 100);
      }
    });
  }

  // Initialize visitor tracking
  registerVisit();
  displayLeaderboard();

})();
</script>
</body>
</html>
